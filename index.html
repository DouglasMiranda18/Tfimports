<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFI IMPORTS ‚Äî Moda Masculina Premium</title>
  <meta name="description" content="TFI IMPORTS ‚Äî Moda masculina premium inspirada no lifestyle Playboy. Exclusividade, atitude e sofistica√ß√£o. Compre online: camisetas, cal√ßas, bermudas, cuecas premium e mais." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2712%27 fill=%27%230b1220%27/%3E%3Cpath d=%27M13 46c8-2 14-9 19-18 2-4 5-7 9-9 4-2 9-2 10 2s-2 10-7 13c-3 2-6 2-9 3-6 2-9 6-10 10-1 3-7 3-12-1z%27 fill=%27%2346d39a%27/%3E%3Ctext x=%2732%27 y=%2738%27 font-size=%2722%27 text-anchor=%27middle%27 fill=%27%23e5edf8%27 font-family=%27Georgia, serif%27%3ETF%3C/text%3E%3C/svg%3E" />
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com;
    style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
    img-src 'self' data: https:;
    connect-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://firestore.googleapis.com;
    font-src 'self' data:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  " />
  
  <!-- Outros headers de seguran√ßa -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @font-face {
      font-family: "InterVar";
      src: local("Inter");
    }
    :root{
      --ink:#0b1220; /* azul escuro profundo */
      --night:#070b12; /* quase preto */
      --accent:#1dd1a1; /* verde sofisticado */
      --accent-2:#18b68c;
      --ink-2:#101b33;
      --paper:#e5edf8;
    }
    html,body { background: radial-gradient(1200px 600px at 70% -10%, #0f1a33 0%, var(--night) 45%) fixed, var(--night); color: #e8f0ff; }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }
    .btn {
      transition: transform .15s ease, box-shadow .15s ease, background .2s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 28px rgba(0,0,0,.32); }
    .pulse {
      animation: pulse 2.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .tag {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #041313;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .card-img {
      background: linear-gradient(140deg, #0f1a2e, #0a0f1f);
    }
    .star { color: #ffd166; }
    .badge { background: rgba(29, 209, 161, .12); color: var(--accent); border: 1px solid rgba(29,209,161,.35); }
    .nav-active { color: var(--accent); }
    .gradient-title {
      background: linear-gradient(90deg, #bcd5ff, #7fb7ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .cta-gradient {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #041313;
    }
    .shadow-soft { box-shadow: 0 20px 50px rgba(0,0,0,.35); }
    .ring-accent { box-shadow: inset 0 0 0 1px rgba(29,209,161,.4); }
    .grid-auto-fit { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .hidden-scroll::-webkit-scrollbar { display: none; }
    .hidden-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .qr {
      background: conic-gradient(from 90deg at 1px 1px, #000 90deg, #fff 0) 0 0/8px 8px;
      image-rendering: pixelated;
      border: 8px solid #fff;
    }
    .panel { display: none; }
    .panel.active { display: block; }
    .modal-mask { background: rgba(3,6,12,.6); backdrop-filter: blur(4px); }
    .hint { color: #9bb6da; }
    .pill { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.18) }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <!-- M√≥dulos de seguran√ßa -->
  <script type="module" src="config.js"></script>
  <script type="module" src="security.js"></script>
</head>
<body class="font-[InterVar] selection:bg-emerald-300 selection:text-black">
  <!-- Header -->
  <header class="sticky top-0 z-40 glass">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center ring-accent">
          <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden="true">
            <rect width="64" height="64" rx="12" fill="#0b1220"/>
            <path d="M13 46c8-2 14-9 19-18 2-4 5-7 9-9 4-2 9-2 10 2s-2 10-7 13c-3 2-6 2-9 3-6 2-9 6-10 10-1 3-7 3-12-1z" fill="#1dd1a1"/>
          </svg>
        </div>
        <div>
          <div class="text-xl font-extrabold tracking-wide gradient-title">TFI IMPORTS</div>
          <div class="text-xs uppercase tracking-widest text-slate-300">Exclusividade ‚Ä¢ Atitude ‚Ä¢ Sofistica√ß√£o</div>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#home" data-route class="hover:text-emerald-300">Home</a>
        <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
        <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
        <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
        <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        <a href="#minha-conta" data-route id="navMinhaConta" class="ml-2 px-3 py-1 rounded-full pill hidden">Minha Conta</a>
        <a href="#admin" data-route id="navAdmin" class="ml-2 px-3 py-1 rounded-full badge hidden">Painel Admin</a>
      </nav>

      <div class="flex items-center gap-3">
        <button id="btnLogin" class="btn px-3 py-2 rounded-lg pill text-slate-200 hover:text-white">Entrar</button>
        <a href="#carrinho" data-route id="miniCart" class="relative btn px-3 py-2 rounded-lg pill hover:text-white">
          <span>üõí</span>
          <span id="cartCount" class="absolute -top-2 -right-2 bg-emerald-400 text-black text-xs font-bold w-6 h-6 rounded-full grid place-items-center">0</span>
        </a>
        <button id="btnMenu" class="md:hidden btn px-3 py-2 rounded-lg pill">‚ò∞</button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden glass border-t border-white/10">
      <div class="px-4 py-3 flex flex-col gap-3">
        <a href="#home" data-route class="hover:text-emerald-300">Home</a>
        <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
        <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
        <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
        <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        <a href="#minha-conta" data-route id="navMinhaContaMobile" class="px-3 py-2 rounded-lg pill text-center hidden">Minha Conta</a>
        <a href="#admin" data-route id="navAdminMobile" class="px-3 py-2 rounded-lg badge text-center hidden">Painel Admin</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="home" class="panel active">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-10 pb-12">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <div class="inline-flex items-center gap-2 tag px-3 py-1 rounded-full mb-4">LIFESTYLE PLAYBOY</div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
            Moda masculina premium com presen√ßa, confian√ßa e impacto.
          </h1>
          <p class="mt-4 text-slate-300">
            Pe√ßas que destacam atitude e sofistica√ß√£o. Se vista como quem lidera.
          </p>
          <div class="mt-6 flex flex-wrap gap-4">
            <a href="#loja" data-route class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Comprar agora</a>
            <a href="#novidades" data-route class="btn px-5 py-3 rounded-xl pill text-slate-200 hover:text-white">Ver lan√ßamentos</a>
          </div>
          <div class="mt-6 flex items-center gap-4 text-sm text-slate-400">
            <div class="flex items-center gap-2"><span class="star">‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ</span> <span>+320 avalia√ß√µes</span></div>
            <div class="hidden sm:block">‚Ä¢</div>
            <div>Envio r√°pido e rastre√°vel</div>
          </div>
        </div>
        <div class="relative">
          <div class="glass shadow-soft rounded-3xl p-6 ring-accent">
            <div class="grid grid-cols-3 gap-3">
              <!-- Vitrines SVG (substitua por fotos reais depois) -->
              <div class="card-img rounded-2xl h-36 flex items-center justify-center">
                <svg viewBox="0 0 120 120" class="w-24 h-24">
                  <rect x="10" y="10" width="100" height="100" rx="16" fill="#0b1a34"/>
                  <path d="M20 90 L45 40 L75 60 L100 30" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                </svg>
              </div>
              <div class="card-img rounded-2xl h-36 flex items-center justify-center">
                <svg viewBox="0 0 120 120" class="w-24 h-24">
                  <circle cx="60" cy="60" r="42" fill="#0b1a34"/>
                  <path d="M35 70 Q60 30 85 70" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                </svg>
              </div>
              <div class="card-img rounded-2xl h-36 flex items-center justify-center">
                <svg viewBox="0 0 120 120" class="w-24 h-24">
                  <rect x="25" y="25" width="70" height="70" rx="12" fill="#0b1a34"/>
                  <path d="M30 80 L90 80" stroke="#1dd1a1" stroke-width="6"/>
                </svg>
              </div>
              <div class="col-span-3 glass rounded-2xl p-4 flex items-center justify-between">
                <div>
                  <div class="text-sm text-slate-300">Cole√ß√£o destaque</div>
                  <div class="text-lg font-bold">TFI Black Label</div>
                </div>
                <a href="#loja" data-route class="btn px-4 py-2 rounded-lg cta-gradient font-bold">Ver</a>
              </div>
            </div>
          </div>
          <div class="absolute -top-4 -right-4 tag px-3 py-1 rounded-full pulse">Novo</div>
        </div>
      </div>

      <!-- Faixa de categorias -->
      <div class="mt-12 hidden-scroll overflow-x-auto">
        <div id="categoryChips" class="flex gap-3 min-w-max">
          <!-- chips dinamicos -->
        </div>
      </div>

      <!-- Destaques -->
      <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">Destaques</h2>
        <div id="featuredGrid" class="grid-auto-fit"></div>
      </div>
    </div>
  </section>

  <!-- Loja -->
  <section id="loja" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Filtros -->
        <aside class="md:w-64 glass rounded-2xl p-5 h-max">
          <h3 class="font-bold text-lg mb-3">Filtrar</h3>
          <div class="space-y-4">
            <div>
              <div class="text-sm text-slate-300 mb-2">Categoria</div>
              <select id="filterCategoria" class="w-full bg-transparent pill px-3 py-2 rounded-lg">
                <option value="">Todas</option>
              </select>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Tamanho</div>
              <div id="filterTamanho" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Cor</div>
              <div id="filterCor" class="flex flex-wrap gap-2"></div>
            </div>
            <button id="btnLimparFiltros" class="btn w-full mt-2 px-4 py-2 rounded-lg pill">Limpar filtros</button>
          </div>
        </aside>
        <!-- Lista -->
        <div class="flex-1">
          <div class="flex items-center justify-between gap-4 mb-4">
            <h2 class="text-2xl font-bold">Produtos</h2>
            <select id="ordenacao" class="bg-transparent pill px-3 py-2 rounded-lg">
              <option value="relevancia">Relev√¢ncia</option>
              <option value="menor-preco">Menor pre√ßo</option>
              <option value="maior-preco">Maior pre√ßo</option>
              <option value="novidades">Novidades</option>
            </select>
          </div>
          <div id="catalogoGrid" class="grid-auto-fit"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Novidades -->
  <section id="novidades" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Novidades e Promo√ß√µes</h2>
        <span class="badge px-3 py-1 rounded-full">Atualizado semanalmente</span>
      </div>
      <div id="novidadesGrid" class="mt-6 grid-auto-fit"></div>
    </div>
  </section>

  <!-- Feedbacks -->
  <section id="feedbacks" class="panel">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Feedbacks de Clientes</h2>
      <div id="feedbackList" class="space-y-4"></div>
      <div class="glass rounded-2xl p-5 mt-6">
        <h3 class="font-bold mb-2">Deixe seu feedback</h3>
        <div class="flex items-center gap-2 mb-3" id="ratingStars">
          <!-- estrelas -->
        </div>
        <textarea id="feedbackText" class="w-full bg-transparent pill p-3 rounded-lg" rows="3" placeholder="Escreva um coment√°rio..."></textarea>
        <div class="mt-3 flex justify-end">
          <button id="btnEnviarFeedback" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Enviar</button>
        </div>
        <p class="hint mt-2">Seu feedback ser√° salvo e exibido para outros clientes.</p>
      </div>
    </div>
  </section>

  <!-- Contato -->
  <section id="contato" class="panel">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Contato e Redes</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-2">Fale com a TFI IMPORTS</h3>
          <div id="chatBox" class="h-56 overflow-y-auto hidden-scroll glass rounded-xl p-3"></div>
          <div class="mt-3 flex gap-2">
            <input id="chatInput" class="flex-1 bg-transparent pill px-3 py-2 rounded-lg" placeholder="Escreva sua mensagem..." />
            <button id="btnChat" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Enviar</button>
          </div>
          <p class="hint mt-2">Nossa equipe responder√° em breve. Atendimento 24/7.</p>
        </div>
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-2">Instagram Oficial</h3>
          <p class="text-slate-300">Siga para ver lan√ßamentos, making-of e ofertas exclusivas.</p>
          <a href="https://instagram.com" target="_blank" rel="noopener" class="btn mt-3 px-4 py-2 rounded-lg pill inline-flex items-center gap-2 hover:text-white">üì∏ Abrir Instagram</a>
          <div class="mt-4 grid grid-cols-3 gap-3">
            <!-- Placeholders de posts -->
            <div class="card-img rounded-xl h-24"></div>
            <div class="card-img rounded-xl h-24"></div>
            <div class="card-img rounded-xl h-24"></div>
          </div>
          <p class="hint mt-2">Pr√©-visualiza√ß√£o ilustrativa. A incorpora√ß√£o direta do feed n√£o √© suportada aqui.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Produto (detalhe) -->
  <section id="produto" class="panel">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
      <button class="btn pill px-3 py-2 rounded-lg mb-4" onclick="navigate('#loja')">‚Üê Voltar</button>
      <div id="produtoWrap" class="grid md:grid-cols-2 gap-6">
        <!-- conteudo dinamico -->
      </div>
    </div>
  </section>

  <!-- Carrinho -->
  <section id="carrinho" class="panel">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Seu Carrinho</h2>
      <div id="cartList" class="space-y-4"></div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-slate-300">Frete calculado no checkout.</div>
        <div class="text-right">
          <div class="text-sm">Subtotal</div>
          <div class="text-2xl font-extrabold" id="cartSubtotal">R$ 0,00</div>
        </div>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button onclick="navigate('#loja')" class="btn px-4 py-2 rounded-lg pill">Continuar comprando</button>
        <a href="#checkout" data-route class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Fechar pedido</a>
      </div>
    </div>
  </section>

  <!-- Checkout -->
  <section id="checkout" class="panel">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Finalizar Compra</h2>
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Endere√ßo e Frete</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="cep" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="CEP" />
            <input id="cidade" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Cidade" />
            <input id="uf" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="UF" />
            <button id="btnCalcFrete" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Calcular Frete</button>
          </div>
          <div id="freteOpcoes" class="mt-4 grid sm:grid-cols-2 gap-3"></div>

          <h3 class="font-bold mt-6 mb-3">Pagamento</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="glass rounded-xl p-4">
              <div class="flex items-center gap-2 mb-2"><span class="badge px-2 py-1 rounded-full">Pix</span><span class="text-slate-300">Aprova√ß√£o r√°pida</span></div>
              <div class="bg-white rounded-xl p-3 grid place-items-center">
                <div class="qr w-48 h-48"></div>
              </div>
              <button id="btnSimularPix" class="btn cta-gradient w-full mt-3 px-4 py-2 rounded-lg font-bold">Pagar com Pix</button>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="flex items-center gap-2 mb-2"><span class="badge px-2 py-1 rounded-full">Cart√£o</span><span class="text-slate-300">Cr√©dito/D√©bito</span></div>
              <p class="hint">Pagamento com cart√£o ser√° implementado em breve. Use o Pix para pagamentos imediatos.</p>
              <button id="btnSimularCartao" class="btn px-4 py-2 rounded-lg pill w-full mt-3">Em Breve</button>
            </div>
          </div>
        </div>
        <div class="glass rounded-2xl p-5 h-max">
          <h3 class="font-bold mb-3">Resumo</h3>
          <div id="resumoCheckout" class="space-y-2"></div>
          <div class="border-t border-white/10 mt-3 pt-3">
            <div class="flex items-center justify-between">
              <span>Frete</span><span id="resFrete">R$ 0,00</span>
            </div>
            <div class="flex items-center justify-between font-extrabold text-lg mt-1">
              <span>Total</span><span id="resTotal">R$ 0,00</span>
            </div>
          </div>
          <button id="btnFinalizar" class="btn cta-gradient w-full mt-4 px-5 py-3 rounded-xl font-bold">Finalizar Pedido</button>
          <p class="hint mt-2">Seu pedido ser√° processado e voc√™ receber√° confirma√ß√£o por email.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Minha Conta -->
  <section id="minha-conta" class="panel">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Minha Conta</h2>
        <div class="flex items-center gap-2">
          <span id="userWelcome" class="text-sm hint">Bem-vindo!</span>
          <button id="btnLogoutUser" class="btn px-4 py-2 rounded-lg pill">Sair</button>
        </div>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6 mt-6">
        <!-- Informa√ß√µes do Usu√°rio -->
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Informa√ß√µes Pessoais</h3>
          <div id="userInfo" class="space-y-3">
            <div>
              <div class="text-sm text-slate-300">Nome</div>
              <div id="userName" class="font-bold">-</div>
            </div>
            <div>
              <div class="text-sm text-slate-300">Email</div>
              <div id="userEmail" class="font-bold">-</div>
            </div>
            <div>
              <div class="text-sm text-slate-300">Membro desde</div>
              <div id="userSince" class="font-bold">-</div>
            </div>
          </div>
        </div>
        
        <!-- Meus Pedidos -->
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Meus Pedidos</h3>
          <div id="userOrders" class="space-y-3">
            <div class="text-slate-300 text-center py-4">
              Nenhum pedido encontrado
            </div>
          </div>
        </div>
      </div>
      
      <!-- Favoritos -->
      <div class="glass rounded-2xl p-5 mt-6">
        <h3 class="font-bold mb-3">Produtos Favoritos</h3>
        <div id="userFavorites" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-slate-300 text-center py-8">
            Nenhum favorito ainda
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin -->
  <section id="admin" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Painel Admin</h2>
        <div class="flex items-center gap-2">
          <span id="authState" class="text-sm hint">N√£o autenticado</span>
          <button id="btnAdminLogin" class="btn px-4 py-2 rounded-lg pill">Entrar</button>
          <button id="btnLogout" class="btn px-4 py-2 rounded-lg pill hidden">Sair</button>
        </div>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 mt-6">
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Cadastrar Produto</h3>
          <div class="grid grid-cols-2 gap-3">
            <input id="admNome" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Nome do produto" />
            <select id="admCategoria" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2"></select>
            <input id="admPreco" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Pre√ßo (R$)" />
            <input id="admPromo" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Pre√ßo promocional (opcional)" />
            <input id="admCores" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Cores (ex.: preto,branco,azul)" />
            <input id="admTamanhos" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Tamanhos (ex.: P,M,G,GG)" />
            <textarea id="admDesc" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" rows="3" placeholder="Descri√ß√£o curta"></textarea>
            <button id="btnSalvarProduto" class="btn cta-gradient px-4 py-2 rounded-lg font-bold col-span-2">Salvar Produto</button>
          </div>
          <p class="hint mt-2">Os produtos s√£o salvos no Firestore e aparecem automaticamente na loja.</p>
        </div>
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Produtos</h3>
          <div id="adminLista" class="space-y-3 max-h-96 overflow-y-auto hidden-scroll"></div>
        </div>
      </div>


    </div>
  </section>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50">
    <div class="glass rounded-2xl p-6 max-w-md mx-4 w-full">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Entrar na TFI IMPORTS</h3>
        <button id="closeLogin" class="btn pill px-3 py-1 rounded-lg">‚úï</button>
      </div>
      
      <!-- Login com Email/Senha -->
      <div id="emailLoginForm" class="space-y-4">
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="loginEmail" type="email" class="w-full bg-transparent pill px-3 py-2 rounded-lg" placeholder="seu@email.com" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Senha</label>
          <input id="loginPassword" type="password" class="w-full bg-transparent pill px-3 py-2 rounded-lg" placeholder="Sua senha" />
        </div>
        <button id="btnEmailLogin" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold">Entrar</button>
        <button id="btnShowRegister" class="btn pill w-full px-4 py-2 rounded-lg">Criar conta</button>
      </div>
      
      <!-- Registro com Email/Senha -->
      <div id="registerForm" class="space-y-4 hidden">
        <div>
          <label class="block text-sm text-slate-300 mb-2">Nome</label>
          <input id="registerName" type="text" class="w-full bg-transparent pill px-3 py-2 rounded-lg" placeholder="Seu nome completo" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="registerEmail" type="email" class="w-full bg-transparent pill px-3 py-2 rounded-lg" placeholder="seu@email.com" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Senha</label>
          <input id="registerPassword" type="password" class="w-full bg-transparent pill px-3 py-2 rounded-lg" placeholder="M√≠nimo 6 caracteres" />
        </div>
        <button id="btnEmailRegister" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold">Criar Conta</button>
        <button id="btnShowLogin" class="btn pill w-full px-4 py-2 rounded-lg">J√° tenho conta</button>
      </div>
      
      <!-- Divisor -->
      <div class="flex items-center my-4">
        <div class="flex-1 border-t border-white/20"></div>
        <span class="px-3 text-sm text-slate-400">ou</span>
        <div class="flex-1 border-t border-white/20"></div>
      </div>
      
      <!-- Login com Google -->
      <button id="btnGoogleLogin" class="btn pill w-full px-4 py-3 rounded-lg flex items-center justify-center gap-3">
        <svg width="20" height="20" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Entrar com Google
      </button>
      
      <div class="mt-4 text-xs text-center hint">
        Ao entrar, voc√™ concorda com nossos termos de uso.
      </div>
    </div>
  </div>



  <!-- Footer -->
  <footer class="mt-16 border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid md:grid-cols-3 gap-6">
      <div>
        <div class="text-lg font-extrabold gradient-title">TFI IMPORTS</div>
        <p class="text-slate-300 mt-2">Estilo premium com atitude. Atendimento direto no site.</p>
      </div>
      <div>
        <div class="font-bold mb-2">Categorias</div>
        <div id="footerCats" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <div class="font-bold mb-2">Links</div>
        <div class="flex flex-col gap-1">
          <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
          <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
          <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
          <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
          <span class="text-xs hint mt-2">¬© <span id="year"></span> TFI IMPORTS. Todos os direitos reservados.</span>
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    // Importar fun√ß√µes de seguran√ßa
    import { checkRateLimit, sanitizeText, validateProduct } from './security.js';
    
    // Estado global (local)
    const state = {
      user: null,
      adminEmail: 'admin@tfimports.com.br', // Email do administrador
      categorias: [
        "Camisetas","Cal√ßas","Bermudas de linho","Bermudas de sarja","Cueca premium",
        "Camiseta dry fit","Camisa peruana","Camisa polo","Regata USA","Meias","Bermuda high"
      ],
      produtos: [
        {
          id: "p1",
          nome: "Camiseta Black Premium",
          categoria: "Camisetas",
          preco: 199.9,
          promo: 159.9,
          cores: ["preto","branco"],
          tamanhos: ["P","M","G","GG"],
          novas: true,
          destaque: true,
          descricao: "Camiseta premium em algod√£o eg√≠pcio. Toque macio e caimento perfeito.",
          composicao: "100% algod√£o eg√≠pcio",
          estilo: "Casual sofisticado",
          imagens: ["svg"]
        },
        {
          id: "p2",
          nome: "Bermuda de Linho Azul",
          categoria: "Bermudas de linho",
          preco: 249.9,
          promo: null,
          cores: ["azul","areia"],
          tamanhos: ["P","M","G"],
          novas: true,
          destaque: true,
          descricao: "Leve, refrescante e elegante. Ideal para clima quente.",
          composicao: "55% linho, 45% algod√£o",
          estilo: "Summer classy",
          imagens: ["svg"]
        },
        {
          id: "p3",
          nome: "Cueca Premium Comfort",
          categoria: "Cueca premium",
          preco: 69.9,
          promo: 59.9,
          cores: ["preto","cinza"],
          tamanhos: ["M","G","GG"],
          novas: false,
          destaque: true,
          descricao: "Suporte e maciez com respirabilidade para o dia todo.",
          composicao: "Modal com elastano",
          estilo: "Conforto ativo",
          imagens: ["svg"]
        },
        {
          id: "p4",
          nome: "Camisa Polo TFI",
          categoria: "Camisa polo",
          preco: 229.9,
          promo: 199.9,
          cores: ["preto","azul-marinho","branco"],
          tamanhos: ["P","M","G","GG"],
          novas: false,
          destaque: false,
          descricao: "Textura premium e acabamento impec√°vel.",
          composicao: "Algod√£o Pima",
          estilo: "Smart casual",
          imagens: ["svg"]
        },
        {
          id: "p5",
          nome: "Regata USA Cut",
          categoria: "Regata USA",
          preco: 119.9,
          promo: 99.9,
          cores: ["preto","verde"],
          tamanhos: ["P","M","G"],
          novas: true,
          destaque: false,
          descricao: "Corte atl√©tico com visual urbano.",
          composicao: "Poli√©ster com elastano",
          estilo: "Athleisure",
          imagens: ["svg"]
        }
      ],
      carrinho: [],
      freteSelecionado: null
    };

    // Utilidades
    const fmt = v => v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    
    // Verificar se usu√°rio √© admin
    function isAdmin() {
      return state.user && state.user.email === state.adminEmail;
    }

    // Navega√ß√£o SPA
    function navigate(hash) {
      window.location.hash = hash;
    }
    function applyRoute() {
      const hash = window.location.hash || "#home";
      qsa('[data-route]').forEach(a => a.classList.toggle('nav-active', a.getAttribute('href') === hash));
      qsa('.panel').forEach(p => p.classList.remove('active'));
      const id = hash.replace('#','');
      
      // Proteger painel admin - apenas admin pode acessar
      if (id === 'admin') {
        if (!state.user) {
          toast('Fa√ßa login para acessar o painel administrativo.');
          navigate('#home');
          return;
        }
        if (!isAdmin()) {
          toast('Acesso negado. Apenas administradores podem acessar esta √°rea.');
          navigate('#home');
          return;
        }
      }
      
      // Proteger minha conta - apenas usu√°rios logados
      if (id === 'minha-conta' && !state.user) {
        toast('Fa√ßa login para acessar sua conta.');
        navigate('#home');
        return;
      }
      
      const panel = qs('#'+id);
      if (panel) panel.classList.add('active');
      if (id === 'produto') renderProdutoDetalhe();
      if (id === 'carrinho') renderCarrinho();
      if (id === 'checkout') renderCheckoutResumo();
      if (id === 'minha-conta') renderMinhaConta();
    }
    window.addEventListener('hashchange', applyRoute);

    // Header behaviors
    qs('#btnMenu').addEventListener('click', () => {
      qs('#mobileNav').classList.toggle('hidden');
    });

    // Render categorias chips/footer
    function renderChips() {
      const chips = qs('#categoryChips');
      chips.innerHTML = '';
      state.categorias.forEach(cat => {
        const a = document.createElement('a');
        a.href = '#loja';
        a.setAttribute('data-route','');
        a.className = 'pill px-4 py-2 rounded-full hover:text-emerald-300';
        a.textContent = cat;
        a.addEventListener('click', () => {
          qs('#filterCategoria').value = cat;
          filterAndRenderCatalog();
        });
        chips.appendChild(a);
      });
      const footerCats = qs('#footerCats');
      footerCats.innerHTML = '';
      state.categorias.slice(0,6).forEach(cat => {
        const span = document.createElement('span');
        span.className = 'pill px-3 py-1 rounded-full text-sm';
        span.textContent = cat;
        footerCats.appendChild(span);
      });
    }

    // Produto card SVG placeholder
    function svgThumb() {
      return `
        <div class="card-img rounded-2xl aspect-[4/3] grid place-items-center">
          <svg viewBox="0 0 140 100" class="w-24 h-24">
            <rect x="10" y="10" width="120" height="80" rx="12" fill="#0b1a34"/>
            <path d="M20 75 L55 35 L85 55 L120 25" stroke="#1dd1a1" stroke-width="5" fill="none"/>
          </svg>
        </div>`;
    }

    // Destaques
    function renderDestaques() {
      const grid = qs('#featuredGrid');
      grid.innerHTML = '';
      state.produtos.filter(p => p.destaque).slice(0,6).forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${svgThumb()}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs">Novo</span>' : ''}
            </div>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      grid.addEventListener('click', e => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') { openProduto(id); }
        if (act === 'add') { addToCart(id); }
      });
    }

    // Loja: filtros
    function initFilters() {
      const sel = qs('#filterCategoria');
      state.categorias.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
      const sizes = ["PP","P","M","G","GG","XG"];
      const wrapT = qs('#filterTamanho');
      sizes.forEach(t => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill text-sm';
        b.textContent = t;
        b.addEventListener('click', () => {
          b.classList.toggle('badge');
          filterAndRenderCatalog();
        });
        wrapT.appendChild(b);
      });
      const cores = ["preto","branco","azul","verde","cinza","areia"];
      const wrapC = qs('#filterCor');
      cores.forEach(c => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill text-sm capitalize';
        b.textContent = c;
        b.addEventListener('click', () => {
          b.classList.toggle('badge');
          filterAndRenderCatalog();
        });
        wrapC.appendChild(b);
      });
      qs('#btnLimparFiltros').addEventListener('click', () => {
        sel.value = '';
        qsa('#filterTamanho button, #filterCor button').forEach(b => b.classList.remove('badge'));
        filterAndRenderCatalog();
      });
      qs('#ordenacao').addEventListener('change', filterAndRenderCatalog);
    }
    function filterAndRenderCatalog() {
      const grid = qs('#catalogoGrid');
      const cat = qs('#filterCategoria').value;
      const sizesSel = qsa('#filterTamanho button.badge').map(b => b.textContent.trim());
      const coresSel = qsa('#filterCor button.badge').map(b => b.textContent.trim());
      let arr = [...state.produtos];
      if (cat) arr = arr.filter(p => p.categoria === cat);
      if (sizesSel.length) arr = arr.filter(p => p.tamanhos.some(t => sizesSel.includes(t)));
      if (coresSel.length) arr = arr.filter(p => p.cores.some(c => coresSel.includes(c)));
      const ord = qs('#ordenacao').value;
      if (ord === 'menor-preco') arr.sort((a,b)=>(a.promo ?? a.preco) - (b.promo ?? b.preco));
      if (ord === 'maior-preco') arr.sort((a,b)=>(b.promo ?? b.preco) - (a.promo ?? a.preco));
      if (ord === 'novidades') arr.sort((a,b)=> (b.novas?-1:1));
      grid.innerHTML = '';
      arr.forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${svgThumb()}
          <div class="p-4">
            <h3 class="font-bold">${p.nome}</h3>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Remover event listeners antigos e adicionar novo
      grid.replaceWith(grid.cloneNode(true));
      const newGrid = qs('#catalogoGrid');
      newGrid.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') openProduto(id);
        if (act === 'add') addToCart(id);
      });
    }

    // Novidades
    function renderNovidades() {
      const grid = qs('#novidadesGrid');
      grid.innerHTML = '';
      state.produtos.filter(p=>p.novas || p.promo).slice(0,8).forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden';
        el.innerHTML = `
          ${svgThumb()}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.promo ? '<span class="badge px-2 py-1 rounded-full text-xs">Promo</span>' : '<span class="badge px-2 py-1 rounded-full text-xs">Lan√ßamento</span>'}
            </div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Remover event listeners antigos e adicionar novo
      grid.replaceWith(grid.cloneNode(true));
      const newGrid = qs('#novidadesGrid');
      newGrid.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') openProduto(id);
        if (act === 'add') addToCart(id);
      });
    }

    // Produto detalhe
    let currentProdutoId = null;
    function openProduto(id) {
      currentProdutoId = id;
      navigate('#produto');
    }
    function renderProdutoDetalhe() {
      const p = state.produtos.find(x=>x.id===currentProdutoId) || state.produtos[0];
      const wrap = qs('#produtoWrap');
      wrap.innerHTML = `
        <div class="glass rounded-2xl p-5">
          <div class="rounded-xl card-img aspect-square grid place-items-center">
            <svg viewBox="0 0 160 160" class="w-40 h-40">
              <rect x="15" y="15" width="130" height="130" rx="16" fill="#0b1a34"/>
              <path d="M30 120 L70 60 L110 80 L135 45" stroke="#1dd1a1" stroke-width="6" fill="none"/>
            </svg>
          </div>
        </div>
        <div>
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-extrabold">${p.nome}</h1>
            ${p.novas ? '<span class="badge px-3 py-1 rounded-full">Novo</span>' : ''}
          </div>
          <div class="text-sm hint mt-1">${p.categoria}</div>
          <div class="mt-3 flex items-center gap-3">
            <div class="text-3xl font-extrabold">${fmt(p.promo ?? p.preco)}</div>
            ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
          </div>
          <p class="mt-4 text-slate-300">${p.descricao}</p>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm text-slate-300 mb-2">Cor</div>
              <div id="selCores" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Tamanho</div>
              <div id="selTamanhos" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div class="mt-5 flex gap-3">
            <button id="btnAddDetail" class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Adicionar ao carrinho</button>
            <button class="btn px-5 py-3 rounded-xl pill" onclick="navigate('#carrinho')">Ver carrinho</button>
          </div>
          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Composi√ß√£o</div><div class="hint">${p.composicao}</div></div>
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Estilo</div><div class="hint">${p.estilo}</div></div>
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Envio</div><div class="hint">R√°pido e rastre√°vel</div></div>
          </div>
        </div>
      `;
      const cores = qs('#selCores'); const tams = qs('#selTamanhos');
      p.cores.forEach(c => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill capitalize';
        b.textContent = c;
        b.addEventListener('click', () => {
          qsa('#selCores button').forEach(x => x.classList.remove('badge')); b.classList.add('badge');
        });
        cores.appendChild(b);
      });
      p.tamanhos.forEach(t => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill';
        b.textContent = t;
        b.addEventListener('click', () => {
          qsa('#selTamanhos button').forEach(x => x.classList.remove('badge')); b.classList.add('badge');
        });
        tams.appendChild(b);
      });
      qs('#btnAddDetail').onclick = () => {
        const cor = (qsa('#selCores button.badge')[0]||{}).textContent || p.cores[0];
        const tam = (qsa('#selTamanhos button.badge')[0]||{}).textContent || p.tamanhos[0];
        addToCart(p.id, cor, tam, 1);
      };
    }

    // Carrinho
    function loadCart() {
      try { state.carrinho = JSON.parse(localStorage.getItem('tfi_cart')||'[]'); } catch { state.carrinho = []; }
      updateCartCount();
    }
    function saveCart() {
      localStorage.setItem('tfi_cart', JSON.stringify(state.carrinho));
      updateCartCount();
    }
    function updateCartCount() {
      qs('#cartCount').textContent = state.carrinho.reduce((s,i)=>s+i.qtd,0);
    }
    function addToCart(id, cor=null, tam=null, qtd=1) {
      const p = state.produtos.find(x=>x.id===id); if (!p) return;
      const key = id + '|' + (cor||p.cores[0]) + '|' + (tam||p.tamanhos[0]);
      const found = state.carrinho.find(x=>x.key===key);
      if (found) found.qtd += qtd;
      else state.carrinho.push({ key, id, nome: p.nome, preco: p.promo ?? p.preco, cor: cor||p.cores[0], tam: tam||p.tamanhos[0], qtd });
      saveCart();
      // toast simples
      const t = document.createElement('div');
      t.className='fixed bottom-6 right-6 glass rounded-xl p-3'; t.textContent='Adicionado ao carrinho';
      document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
    }
    function renderCarrinho() {
      const list = qs('#cartList'); list.innerHTML='';
      if (!state.carrinho.length){
        list.innerHTML = '<div class="glass rounded-xl p-5 text-slate-300">Seu carrinho est√° vazio.</div>';
      } else {
        state.carrinho.forEach((i, idx) => {
          const row = document.createElement('div');
          row.className = 'glass rounded-2xl p-4 flex items-center justify-between gap-3';
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="card-img rounded-xl w-20 h-16"></div>
              <div>
                <div class="font-bold">${i.nome}</div>
                <div class="hint text-sm">Cor: ${i.cor} ‚Ä¢ Tam: ${i.tam}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="pill px-2 py-1 rounded-lg">${fmt(i.preco)}</div>
              <div class="flex items-center gap-2">
                <button class="btn pill px-2 py-1 rounded-lg" data-idx="${idx}" data-act="menos">‚àí</button>
                <div class="w-8 text-center">${i.qtd}</div>
                <button class="btn pill px-2 py-1 rounded-lg" data-idx="${idx}" data-act="mais">+</button>
              </div>
              <button class="btn px-3 py-2 rounded-lg pill" data-idx="${idx}" data-act="rm">Remover</button>
            </div>
          `;
          list.appendChild(row);
        });
        list.onclick = (e) => {
          const b = e.target.closest('button'); if(!b) return;
          const idx = +b.getAttribute('data-idx'); const act = b.getAttribute('data-act');
          if (act==='mais') state.carrinho[idx].qtd++;
          if (act==='menos') state.carrinho[idx].qtd = Math.max(1, state.carrinho[idx].qtd-1);
          if (act==='rm') state.carrinho.splice(idx,1);
          saveCart(); renderCarrinho();
        };
      }
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      qs('#cartSubtotal').textContent = fmt(subtotal);
    }

    // Checkout demo
    function renderCheckoutResumo() {
      const box = qs('#resumoCheckout'); box.innerHTML='';
      if (!state.carrinho.length) {
        box.innerHTML = '<div class="hint">Seu carrinho est√° vazio.</div>';
      } else {
        state.carrinho.forEach(i => {
          const line = document.createElement('div');
          line.className = 'flex items-center justify-between';
          line.innerHTML = `<span class="text-slate-300">${i.nome} (${i.qtd})</span><span>${fmt(i.preco*i.qtd)}</span>`;
          box.appendChild(line);
        });
      }
      updateTotals();
    }
    function updateTotals() {
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      const frete = state.freteSelecionado?.preco || 0;
      qs('#resFrete').textContent = fmt(frete);
      qs('#resTotal').textContent = fmt(subtotal + frete);
    }
    qs('#btnCalcFrete').addEventListener('click', () => {
      const cep = (qs('#cep').value||'').replace(/\D/g,'');
      const op = qs('#freteOpcoes'); op.innerHTML='';
      if (cep.length < 8) {
        op.innerHTML = '<div class="hint">Informe um CEP v√°lido.</div>'; return;
      }
      // C√°lculo fict√≠cio (Demo), substitua por Melhor Envio no backend
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      const base = subtotal > 400 ? 0 : 24.9;
      const opcoes = [
        { id:'exp', nome:'Expresso', prazo:'2-4 dias', preco: base + 19.9 },
        { id:'std', nome:'Padr√£o', prazo:'4-8 dias', preco: base + 9.9 },
      ];
      opcoes.forEach(o=>{
        const d = document.createElement('label');
        d.className = 'glass rounded-xl p-3 flex items-center justify-between cursor-pointer';
        d.innerHTML = `<div><div class="font-bold">${o.nome}</div><div class="hint text-sm">${o.prazo}</div></div>
          <div class="flex items-center gap-3"><div class="font-extrabold">${fmt(o.preco)}</div><input type="radio" name="frete" value="${o.id}"></div>`;
        op.appendChild(d);
      });
      op.onclick = (e) => {
        const r = e.target.closest('input[type=radio]'); if (!r) return;
        const o = (r.value==='exp') ? opcoes[0] : opcoes[1];
        state.freteSelecionado = o; updateTotals();
      };
    });

    // Pagamento
    qs('#btnSimularPix').addEventListener('click', () => {
      toast('Pagamento Pix processado! Aguarde confirma√ß√£o.');
    });
    qs('#btnSimularCartao').addEventListener('click', () => {
      toast('Pagamento com cart√£o ser√° implementado em breve.');
    });
    qs('#btnFinalizar').addEventListener('click', async () => {
      if (!state.carrinho.length) { toast('Adicione produtos antes de finalizar.'); return; }
      
      try {
        // Salvar pedido no Firestore
        const pedidoData = {
          itens: state.carrinho,
          subtotal: state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0),
          frete: state.freteSelecionado?.preco || 0,
          total: state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0) + (state.freteSelecionado?.preco || 0),
          status: 'pendente',
          criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
          userId: state.user?.uid || null,
          email: state.user?.email || null
        };
        
        const docRef = await db.collection('pedidos').add(pedidoData);
        
        toast(`Pedido #${docRef.id} finalizado! Voc√™ receber√° confirma√ß√£o por e-mail.`);
        state.carrinho = []; 
        saveCart(); 
        renderCheckoutResumo(); 
        updateCartCount();
        
      } catch (error) {
        console.error('Erro ao finalizar pedido:', error);
        toast('Erro ao finalizar pedido. Tente novamente.');
      }
    });

    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 glass rounded-xl px-4 py-3';
      t.textContent = msg; document.body.appendChild(t);
      setTimeout(()=>t.remove(),1600);
    }

    // Renderizar √°rea "Minha Conta"
    async function renderMinhaConta() {
      if (!state.user) return;
      
      // Atualizar informa√ß√µes do usu√°rio
      qs('#userName').textContent = state.user.displayName || 'Usu√°rio';
      qs('#userEmail').textContent = state.user.email;
      qs('#userSince').textContent = state.user.metadata?.creationTime ? 
        new Date(state.user.metadata.creationTime).toLocaleDateString('pt-BR') : 'Data n√£o dispon√≠vel';
      qs('#userWelcome').textContent = `Ol√°, ${state.user.displayName || 'Usu√°rio'}!`;
      
      // Carregar pedidos do usu√°rio
      await loadUserOrders();
      
      // Carregar favoritos (implementar depois se necess√°rio)
      renderUserFavorites();
    }
    
    // Carregar pedidos do usu√°rio
    async function loadUserOrders() {
      try {
        if (!db || !state.user) return;
        
        const snapshot = await db.collection('pedidos')
          .where('userId', '==', state.user.uid)
          .orderBy('criadoEm', 'desc')
          .limit(5)
          .get();
        
        const ordersContainer = qs('#userOrders');
        ordersContainer.innerHTML = '';
        
        if (snapshot.empty) {
          ordersContainer.innerHTML = '<div class="text-slate-300 text-center py-4">Nenhum pedido encontrado</div>';
          return;
        }
        
        snapshot.forEach(doc => {
          const order = doc.data();
          const orderEl = document.createElement('div');
          orderEl.className = 'glass rounded-xl p-3';
          orderEl.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <div class="font-bold">Pedido #${doc.id.slice(-6)}</div>
                <div class="text-sm text-slate-300">${order.itens?.length || 0} item(ns)</div>
              </div>
              <div class="text-right">
                <div class="font-bold">${fmt(order.total || 0)}</div>
                <div class="text-sm badge px-2 py-1 rounded-full">${order.status || 'Pendente'}</div>
              </div>
            </div>
          `;
          ordersContainer.appendChild(orderEl);
        });
        
      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        qs('#userOrders').innerHTML = '<div class="text-slate-300 text-center py-4">Erro ao carregar pedidos</div>';
      }
    }
    
    // Renderizar favoritos do usu√°rio
    function renderUserFavorites() {
      const favoritesContainer = qs('#userFavorites');
      favoritesContainer.innerHTML = '<div class="text-slate-300 text-center py-8">Nenhum favorito ainda</div>';
      // Implementar sistema de favoritos depois se necess√°rio
    }

    // Feedbacks
    const feedbacks = [
      { nome:'Rafael', nota:5, texto:'Qualidade absurda. Caimento perfeito.', data:'h√° 2 dias' },
      { nome:'Lucas', nota:5, texto:'Entrega r√°pida e pe√ßas com presen√ßa.', data:'h√° 1 semana' },
      { nome:'Henrique', nota:4, texto:'Camiseta premium real, recomendo.', data:'h√° 3 semanas' }
    ];
    function renderFeedbacks() {
      const list = qs('#feedbackList'); list.innerHTML='';
      feedbacks.forEach(f => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl p-4';
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-bold">${f.nome}</div>
            <div class="text-sm hint">${f.data}</div>
          </div>
          <div class="mt-1 star">${'‚òÖ'.repeat(f.nota)}<span class="text-slate-600">${'‚òÖ'.repeat(5-f.nota)}</span></div>
          <p class="mt-2 text-slate-300">${f.texto}</p>
        `;
        list.appendChild(el);
      });
    }
    // estrelas input
    let currentRating = 5;
    function initRating() {
      const box = qs('#ratingStars'); box.innerHTML='';
      for (let i=1;i<=5;i++){
        const b = document.createElement('button');
        b.className = 'text-2xl'; b.textContent = '‚òÖ';
        b.style.color = (i<=currentRating)?'#ffd166':'#334155';
        b.addEventListener('click', ()=>{
          currentRating = i;
          qsa('#ratingStars button').forEach((x,idx)=> x.style.color = (idx < i)?'#ffd166':'#334155');
        });
        box.appendChild(b);
      }
      qs('#btnEnviarFeedback').onclick = async () => {
        // Verificar rate limiting
        if (!checkRateLimit('feedback', 3, 300000)) { // 3 tentativas por 5 minutos
          toast('Muitas tentativas. Aguarde 5 minutos.');
          return;
        }
        
        const txt = qs('#feedbackText').value.trim();
        if (!txt) { toast('Escreva um coment√°rio.'); return; }
        
        // Sanitizar dados
        const sanitizedText = sanitizeText(txt);
        const sanitizedName = sanitizeText(state.user?.displayName || 'Cliente');
        
        if (sanitizedText.length < 3) {
          toast('Coment√°rio muito curto.');
          return;
        }
        
        try {
          // Salvar no Firestore
          const feedbackData = {
            nome: sanitizedName,
            nota: currentRating,
            texto: sanitizedText,
            data: new Date().toLocaleDateString('pt-BR'),
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            userId: state.user?.uid || null
          };
          
          await db.collection('feedbacks').add(feedbackData);
          
          // Adicionar ao estado local
          feedbacks.unshift({ 
            nome: sanitizedName, 
            nota: currentRating, 
            texto: sanitizedText, 
            data: 'agora' 
          });
          
          qs('#feedbackText').value='';
          renderFeedbacks();
          toast('Obrigado pelo feedback!');
          
        } catch (error) {
          console.error('Erro ao salvar feedback:', error);
          toast('Erro ao enviar feedback. Tente novamente.');
        }
      };
    }

    // Chat simples
    const chatMsgs = [];
    function renderChat() {
      const box = qs('#chatBox');
      box.innerHTML = chatMsgs.map(m => `
        <div class="flex ${m.me?'justify-end':'justify-start'}">
          <div class="max-w-[80%] ${m.me?'cta-gradient':'glass'} rounded-xl px-3 py-2 my-1">${m.txt}</div>
        </div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    }
    qs('#btnChat').addEventListener('click', async () => {
      const input = qs('#chatInput'); const txt = input.value.trim();
      if (!txt) return;
      
      try {
        // Salvar mensagem no Firestore
        const mensagemData = {
          texto: sanitizeText(txt),
          remetente: 'cliente',
          userId: state.user?.uid || null,
          email: state.user?.email || null,
          criadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('mensagens').add(mensagemData);
        
        chatMsgs.push({ me:true, txt }); 
        input.value='';
        renderChat();
        
        setTimeout(()=>{ 
          chatMsgs.push({ me:false, txt:'Recebido! Nossa equipe retornar√° em breve.' }); 
          renderChat(); 
        }, 700);
        
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        toast('Erro ao enviar mensagem. Tente novamente.');
      }
    });

    // Admin: inserir produto local
    function adminFillCategorias() {
      const sel = qs('#admCategoria'); sel.innerHTML='';
      state.categorias.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
      });
    }
    qs('#btnSalvarProduto').addEventListener('click', async () => {
      if (!state.user) { toast('Fa√ßa login com Google para salvar produtos.'); return; }
      
      // Verificar rate limiting
      if (!checkRateLimit('addProduct', 5, 60000)) { // 5 produtos por minuto
        toast('Muitas tentativas. Aguarde 1 minuto.');
        return;
      }
      
      // Coletar e sanitizar dados
      const nome = sanitizeText(qs('#admNome').value.trim());
      const cat = qs('#admCategoria').value;
      const preco = parseFloat(qs('#admPreco').value.replace(',','.'))||0;
      const promo = qs('#admPromo').value ? parseFloat(qs('#admPromo').value.replace(',','.')) : null;
      const cores = qs('#admCores').value.split(',').map(s=>sanitizeText(s.trim())).filter(Boolean);
      const tams = qs('#admTamanhos').value.split(',').map(s=>sanitizeText(s.trim())).filter(Boolean);
      const desc = sanitizeText(qs('#admDesc').value.trim());
      
      // Validar dados
      const produto = { nome, categoria: cat, preco, promo, cores, tamanhos: tams, descricao: desc };
      const validation = validateProduct(produto);
      
      if (!validation.isValid) {
        toast('Erro: ' + validation.errors.join(', '));
        return;
      }
      
      if (!nome || !preco || !cores.length || !tams.length) { 
        toast('Preencha os campos obrigat√≥rios.'); 
        return; 
      }
      
      try {
        // Salvar no Firestore
        const produtoData = {
          nome,
          categoria: cat,
          preco,
          promo,
          cores,
          tamanhos: tams,
          novas: true,
          destaque: false,
          descricao: desc || 'Sem descri√ß√£o',
          composicao: 'A definir',
          estilo: 'TFI Signature',
          imagens: ['svg'],
          criadoPor: state.user.uid,
          criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
          atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const docRef = await db.collection('produtos').add(produtoData);
        
        // Adicionar ao estado local
        const novo = { 
          id: docRef.id, 
          ...produtoData
        };
        
        state.produtos.unshift(novo);
        persistLocalProducts();
        filterAndRenderCatalog(); 
        renderDestaques(); 
        renderNovidades(); 
        renderAdminList();
        toast('Produto salvo com sucesso!');
        
        // Limpar formul√°rio
        ['#admNome','#admPreco','#admPromo','#admCores','#admTamanhos','#admDesc'].forEach(s=>qs(s).value='');
        
      } catch (error) {
        console.error('Erro ao salvar produto:', error);
        toast('Erro ao salvar produto. Tente novamente.');
      }
    });
    function renderAdminList() {
      const box = qs('#adminLista'); box.innerHTML='';
      state.produtos.slice(0,20).forEach(p=>{
        const row = document.createElement('div');
        row.className='glass rounded-xl p-3 flex items-center justify-between';
        row.innerHTML = `<div><div class="font-bold">${p.nome}</div><div class="hint text-sm">${p.categoria}</div></div>
        <div class="flex items-center gap-2">
          <button class="btn pill px-3 py-1 rounded-lg" data-id="${p.id}" data-act="dest">${p.destaque?'Remover destaque':'Destacar'}</button>
          <button class="btn pill px-3 py-1 rounded-lg" data-id="${p.id}" data-act="del">Excluir</button>
        </div>`;
        box.appendChild(row);
      });
      box.onclick = async (e)=>{
        const b = e.target.closest('button'); if(!b) return;
        const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
        const idx = state.produtos.findIndex(p=>p.id===id); if (idx<0) return;
        
        try {
          if (act==='dest') {
            state.produtos[idx].destaque = !state.produtos[idx].destaque;
            // Atualizar no Firestore
            await db.collection('produtos').doc(id).update({
              destaque: state.produtos[idx].destaque,
              atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          if (act==='del') {
            // Remover do Firestore
            await db.collection('produtos').doc(id).delete();
            state.produtos.splice(idx,1);
          }
          
          persistLocalProducts(); 
          renderAdminList(); 
          renderDestaques(); 
          filterAndRenderCatalog(); 
          renderNovidades();
          
        } catch (error) {
          console.error('Erro ao atualizar produto:', error);
          toast('Erro ao atualizar produto.');
        }
      }
    }
    function persistLocalProducts() {
      localStorage.setItem('tfi_products', JSON.stringify(state.produtos));
    }
    function loadLocalProducts() {
      try {
        const arr = JSON.parse(localStorage.getItem('tfi_products')||'[]');
        if (Array.isArray(arr) && arr.length) state.produtos = arr;
      } catch {}
    }



    // Firebase Configuration
    let firebaseConfig;
    let firebaseApp, auth, db, provider;
    
    async function loadFirebaseConfig() {
      try {
        const configModule = await import('./config.js');
        firebaseConfig = configModule.firebaseConfig;
        console.log('Configura√ß√£o Firebase carregada');
      } catch (error) {
        console.error('Erro ao carregar configura√ß√£o:', error);
        // Fallback para configura√ß√£o padr√£o
        firebaseConfig = {
          apiKey: "AIzaSyD__XrPqFeh4_K0ih4l1reNvWxjW7VItPw",
          authDomain: "tfimports-27898.firebaseapp.com",
          projectId: "tfimports-27898",
          storageBucket: "tfimports-27898.firebasestorage.app",
          messagingSenderId: "379291286011",
          appId: "1:379291286011:web:1feb4711b5235b04c4b35e",
          measurementId: "G-B742BVBRES"
        };
      }
    }
    
    async function initializeFirebase() {
      await loadFirebaseConfig();
      
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        provider = new firebase.auth.GoogleAuthProvider();
        
        // Configura√ß√µes de seguran√ßa
        provider.addScope('email');
        provider.addScope('profile');
        
        console.log('Firebase inicializado com sucesso');
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
      }
    }
    function updateAuthUI() {
      if (state.user) {
        const isUserAdmin = isAdmin();
        
        // Atualizar estado do admin
        qs('#authState').textContent = `Ol√°, ${state.user.displayName||'admin'}`;
        qs('#btnLogout').classList.toggle('hidden', !isUserAdmin);
        qs('#btnAdminLogin').classList.toggle('hidden', isUserAdmin);
        
        // Atualizar navega√ß√£o principal
        qs('#btnLogin').textContent = 'Conta';
        qs('#btnLogin').onclick = () => navigate('#minha-conta');
        
        // Mostrar links corretos na navega√ß√£o
        qs('#navMinhaConta').classList.toggle('hidden', isUserAdmin);
        qs('#navAdmin').classList.toggle('hidden', !isUserAdmin);
        qs('#navMinhaContaMobile').classList.toggle('hidden', isUserAdmin);
        qs('#navAdminMobile').classList.toggle('hidden', !isUserAdmin);
        
      } else {
        // Usu√°rio n√£o logado
        qs('#authState').textContent = 'N√£o autenticado';
        qs('#btnLogout').classList.add('hidden');
        qs('#btnAdminLogin').classList.remove('hidden');
        qs('#btnLogin').textContent = 'Entrar';
        qs('#btnLogin').onclick = openLoginModal;
        
        // Esconder links de navega√ß√£o
        qs('#navMinhaConta').classList.add('hidden');
        qs('#navAdmin').classList.add('hidden');
        qs('#navMinhaContaMobile').classList.add('hidden');
        qs('#navAdminMobile').classList.add('hidden');
      }
    }
    // Login com email/senha
    async function signInEmail() {
      const email = qs('#loginEmail').value.trim();
      const password = qs('#loginPassword').value;
      
      if (!email || !password) {
        toast('Preencha email e senha.');
        return;
      }
      
      if (!auth) { toast('Login indispon√≠vel neste ambiente.'); return; }
      
      try {
        const res = await auth.signInWithEmailAndPassword(email, password);
        state.user = res.user;
        updateAuthUI();
        closeLoginModal();
        toast('Login realizado com sucesso!');
        
        // Salvar dados do usu√°rio no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no login:', error);
        if (error.code === 'auth/user-not-found') {
          toast('Usu√°rio n√£o encontrado.');
        } else if (error.code === 'auth/wrong-password') {
          toast('Senha incorreta.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inv√°lido.');
        } else {
          toast('Erro no login. Tente novamente.');
        }
      }
    }
    
    // Registro com email/senha
    async function signUpEmail() {
      const name = qs('#registerName').value.trim();
      const email = qs('#registerEmail').value.trim();
      const password = qs('#registerPassword').value;
      
      if (!name || !email || !password) {
        toast('Preencha todos os campos.');
        return;
      }
      
      if (password.length < 6) {
        toast('Senha deve ter pelo menos 6 caracteres.');
        return;
      }
      
      if (!auth) { toast('Registro indispon√≠vel neste ambiente.'); return; }
      
      try {
        const res = await auth.createUserWithEmailAndPassword(email, password);
        
        // Atualizar perfil do usu√°rio
        await res.user.updateProfile({
          displayName: name
        });
        
        state.user = res.user;
        updateAuthUI();
        closeLoginModal();
        toast('Conta criada com sucesso!');
        
        // Salvar dados do usu√°rio no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no registro:', error);
        if (error.code === 'auth/email-already-in-use') {
          toast('Email j√° est√° em uso.');
        } else if (error.code === 'auth/weak-password') {
          toast('Senha muito fraca.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inv√°lido.');
        } else {
          toast('Erro ao criar conta. Tente novamente.');
        }
      }
    }
    
    // Login com Google
    function signInGoogle() {
      if (!auth) { toast('Login indispon√≠vel neste ambiente.'); return; }
      auth.signInWithPopup(provider).then(async res => {
        state.user = res.user; 
        updateAuthUI(); 
        closeLoginModal();
        toast('Login realizado com sucesso!');
        
        // Salvar dados do usu√°rio no Firestore
        await saveUserData();
        
      }).catch((error)=> {
        console.error('Erro no login:', error);
        toast('Erro no login. Tente novamente.');
      });
    }
    
    // Salvar dados do usu√°rio no Firestore
    async function saveUserData() {
      try {
        await db.collection('usuarios').doc(state.user.uid).set({
          nome: state.user.displayName,
          email: state.user.email,
          ultimoLogin: firebase.firestore.FieldValue.serverTimestamp(),
          isAdmin: false // Por padr√£o, novos usu√°rios n√£o s√£o admin
        }, { merge: true });
      } catch (error) {
        console.error('Erro ao salvar dados do usu√°rio:', error);
      }
    }
    function signOut() {
      if (!auth) { state.user=null; updateAuthUI(); return; }
      auth.signOut().then(()=> { state.user=null; updateAuthUI(); toast('Voc√™ saiu.'); });
    }
    
    // Controle do modal de login
    function openLoginModal() {
      qs('#loginModal').classList.remove('hidden');
    }
    
    function closeLoginModal() {
      qs('#loginModal').classList.add('hidden');
      // Limpar formul√°rios
      qs('#loginEmail').value = '';
      qs('#loginPassword').value = '';
      qs('#registerName').value = '';
      qs('#registerEmail').value = '';
      qs('#registerPassword').value = '';
      // Mostrar formul√°rio de login por padr√£o
      qs('#emailLoginForm').classList.remove('hidden');
      qs('#registerForm').classList.add('hidden');
    }
    
    function showRegisterForm() {
      qs('#emailLoginForm').classList.add('hidden');
      qs('#registerForm').classList.remove('hidden');
    }
    
    function showLoginForm() {
      qs('#emailLoginForm').classList.remove('hidden');
      qs('#registerForm').classList.add('hidden');
    }
    
    // Event listeners
    qs('#btnLogin').addEventListener('click', openLoginModal);
    qs('#btnAdminLogin').addEventListener('click', openLoginModal);
    qs('#closeLogin').addEventListener('click', closeLoginModal);
    qs('#btnEmailLogin').addEventListener('click', signInEmail);
    qs('#btnEmailRegister').addEventListener('click', signUpEmail);
    qs('#btnGoogleLogin').addEventListener('click', signInGoogle);
    qs('#btnShowRegister').addEventListener('click', showRegisterForm);
    qs('#btnShowLogin').addEventListener('click', showLoginForm);
    qs('#btnLogout').addEventListener('click', signOut);
    qs('#btnLogoutUser').addEventListener('click', signOut);
    
    // Fechar modal ao clicar fora
    qs('#loginModal').addEventListener('click', (e) => {
      if (e.target === qs('#loginModal')) {
        closeLoginModal();
      }
    });
    
    // Enter para login
    qs('#loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        signInEmail();
      }
    });
    
    qs('#registerPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        signUpEmail();
      }
    });
    
    if (auth) {
      auth.onAuthStateChanged(u => { state.user = u || null; updateAuthUI(); });
    }

    // Mini util: year
    qs('#year').textContent = new Date().getFullYear();

    // Inicializa√ß√£o
    async function init() {
      // Carregar configura√ß√£o do Firebase primeiro
      await initializeFirebase();
      
      // Carregar dados do Firestore
      await loadProductsFromFirestore();
      await loadFeedbacksFromFirestore();
      
      loadLocalProducts();
      loadCart();
      renderChips();
      renderDestaques();
      initFilters();
      filterAndRenderCatalog();
      renderNovidades();
      renderFeedbacks();
      initRating();
      renderChat();
      adminFillCategorias();
      renderAdminList();
      applyRoute();
    }
    
    // Carregar produtos do Firestore
    async function loadProductsFromFirestore() {
      try {
        if (!db) return;
        
        const snapshot = await db.collection('produtos').orderBy('criadoEm', 'desc').get();
        const firestoreProducts = [];
        
        snapshot.forEach(doc => {
          firestoreProducts.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Adicionar produtos do Firestore ao estado
        state.produtos = [...firestoreProducts, ...state.produtos];
        
        console.log(`${firestoreProducts.length} produtos carregados do Firestore`);
        
      } catch (error) {
        console.error('Erro ao carregar produtos do Firestore:', error);
      }
    }
    
    // Carregar feedbacks do Firestore
    async function loadFeedbacksFromFirestore() {
      try {
        if (!db) return;
        
        const snapshot = await db.collection('feedbacks').orderBy('criadoEm', 'desc').limit(10).get();
        const firestoreFeedbacks = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          firestoreFeedbacks.push({
            nome: data.nome,
            nota: data.nota,
            texto: data.texto,
            data: data.data
          });
        });
        
        // Adicionar feedbacks do Firestore ao estado
        feedbacks.unshift(...firestoreFeedbacks);
        
        console.log(`${firestoreFeedbacks.length} feedbacks carregados do Firestore`);
        
      } catch (error) {
        console.error('Erro ao carregar feedbacks do Firestore:', error);
      }
    }
    init();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9721b30b149bf202',t:'MTc1NTY5MDkwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>