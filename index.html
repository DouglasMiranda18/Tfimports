<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFI IMPORTS ‚Äî Moda Masculina Premium</title>
  <meta name="description" content="TFI IMPORTS ‚Äî Moda masculina premium inspirada no lifestyle Playboy. Exclusividade, atitude e sofistica√ß√£o. Compre online: camisetas, cal√ßas, bermudas, cuecas premium e mais." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2712%27 fill=%27%230b1220%27/%3E%3Cpath d=%27M13 46c8-2 14-9 19-18 2-4 5-7 9-9 4-2 9-2 10 2s-2 10-7 13c-3 2-6 2-9 3-6 2-9 6-10 10-1 3-7 3-12-1z%27 fill=%27%2346d39a%27/%3E%3Ctext x=%2732%27 y=%2738%27 font-size=%2722%27 text-anchor=%27middle%27 fill=%27%23e5edf8%27 font-family=%27Georgia, serif%27%3ETF%3C/text%3E%3C/svg%3E" />
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com;
    style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
    img-src 'self' data: https:;
    connect-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://firestore.googleapis.com https://viacep.com.br https://www.melhorenvio.com.br https://api.mercadopago.com;
    font-src 'self' data:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  " />
  
  <!-- Outros headers de seguran√ßa -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @font-face {
      font-family: "InterVar";
      src: local("Inter");
    }
    :root{
      --ink:#0b1220; /* azul escuro profundo */
      --night:#070b12; /* quase preto */
      --accent:#1dd1a1; /* verde sofisticado */
      --accent-2:#18b68c;
      --ink-2:#101b33;
      --paper:#e5edf8;
    }
    html,body { background: radial-gradient(1200px 600px at 70% -10%, #0f1a33 0%, var(--night) 45%) fixed, var(--night); color: #e8f0ff; }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }
    .btn {
      transition: transform .15s ease, box-shadow .15s ease, background .2s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 28px rgba(0,0,0,.32); }
    .pulse {
      animation: pulse 2.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .tag {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #041313;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .card-img {
      background: linear-gradient(140deg, #0f1a2e, #0a0f1f);
    }
    .star { color: #ffd166; }
    .badge { background: rgba(29, 209, 161, .12); color: var(--accent); border: 1px solid rgba(29,209,161,.35); }
    .nav-active { color: var(--accent); }
    .gradient-title {
      background: linear-gradient(90deg, #bcd5ff, #7fb7ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .cta-gradient {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #041313;
    }
    .shadow-soft { box-shadow: 0 20px 50px rgba(0,0,0,.35); }
    .ring-accent { box-shadow: inset 0 0 0 1px rgba(29,209,161,.4); }
    .grid-auto-fit { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .hidden-scroll::-webkit-scrollbar { display: none; }
    .hidden-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .qr {
      background: conic-gradient(from 90deg at 1px 1px, #000 90deg, #fff 0) 0 0/8px 8px;
      image-rendering: pixelated;
      border: 8px solid #fff;
    }
    .panel { display: none; }
    .panel.active { display: block; }
    .modal-mask { background: rgba(3,6,12,.6); backdrop-filter: blur(4px); }
    .hint { color: #9bb6da; }
    .pill { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.18) }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <!-- M√≥dulos de seguran√ßa -->
  <script type="module" src="config.js"></script>
  <script type="module" src="security.js"></script>
  
  <!-- M√≥dulos de integra√ß√£o -->
  <script type="module" src="api-config.js"></script>
  <script type="module" src="asaas.js"></script>
  <script type="module" src="melhor-envio.js"></script>
  <script type="module" src="order-manager.js"></script>
</head>
<body class="font-[InterVar] selection:bg-emerald-300 selection:text-black">
  <!-- Header -->
  <header class="sticky top-0 z-40 glass">
    <div class="max-w-7xl mx-auto px-3 sm:px-6 py-2 sm:py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 sm:gap-3">
        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center ring-accent">
          <svg width="24" height="24" class="sm:w-7 sm:h-7" viewBox="0 0 64 64" aria-hidden="true">
            <rect width="64" height="64" rx="12" fill="#0b1220"/>
            <path d="M13 46c8-2 14-9 19-18 2-4 5-7 9-9 4-2 9-2 10 2s-2 10-7 13c-3 2-6 2-9 3-6 2-9 6-10 10-1 3-7 3-12-1z" fill="#1dd1a1"/>
          </svg>
        </div>
        <a href="#home" data-route class="hidden sm:block cursor-pointer hover:opacity-80 transition-opacity">
          <div class="text-lg sm:text-xl font-extrabold tracking-wide gradient-title">TFI IMPORTS</div>
          <div class="text-xs uppercase tracking-widest text-slate-300">Exclusividade ‚Ä¢ Atitude ‚Ä¢ Sofistica√ß√£o</div>
        </a>
        <a href="#home" data-route class="block sm:hidden cursor-pointer hover:opacity-80 transition-opacity">
          <div class="text-lg font-extrabold tracking-wide gradient-title">TFI</div>
        </a>
      </div>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#home" data-route class="hover:text-emerald-300">Home</a>
        <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
        <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
        <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
        <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        <a href="#minha-conta" data-route id="navMinhaConta" class="ml-2 px-3 py-1 rounded-full pill hidden">Minha Conta</a>
        <a href="#admin" data-route id="navAdmin" class="ml-2 px-3 py-1 rounded-full badge hidden">Painel Admin</a>
      </nav>

      <div class="flex items-center gap-2 sm:gap-3">
        <button id="btnLogin" class="btn px-3 py-2 rounded-lg pill text-slate-200 hover:text-white text-sm sm:text-base">Entrar</button>
        
        <!-- Contador de Carrinho -->
        <a href="#carrinho" data-route id="miniCart" class="relative btn px-3 py-2 rounded-lg pill hover:text-white group">
          <svg class="w-5 h-5 sm:w-6 sm:h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l-1 12H6L5 9z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9v4m8-4v4"></path>
          </svg>
          <span id="cartCount" class="absolute -top-2 -right-2 bg-gradient-to-r from-emerald-400 to-emerald-500 text-black text-xs font-bold w-5 h-5 sm:w-6 sm:h-6 rounded-full grid place-items-center shadow-lg">0</span>
        </a>
        
        <button id="btnMenu" class="md:hidden btn px-3 py-2 rounded-lg pill">‚ò∞</button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden glass border-t border-white/10">
      <div class="px-4 py-3 flex flex-col gap-3">
        <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
        <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
        <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
        <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        <a href="#minha-conta" data-route id="navMinhaContaMobile" class="px-3 py-2 rounded-lg pill text-center hidden">Minha Conta</a>
        <a href="#admin" data-route id="navAdminMobile" class="px-3 py-2 rounded-lg badge text-center hidden">Painel Admin</a>
      </div>
    </div>
  </header>

  <!-- Bot√£o Flutuante WhatsApp -->
  <a href="https://wa.me/5511999999999?text=Ol√°! Gostaria de saber mais sobre os produtos da TFI IMPORTS" 
     target="_blank" 
     rel="noopener noreferrer"
     class="fixed right-4 bottom-4 z-50 bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 group">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
    </svg>
    <div class="absolute right-16 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white px-3 py-2 rounded-lg text-sm whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300">
      Fale conosco no WhatsApp
    </div>
  </a>

  <!-- Hero -->
  <section id="home" class="panel active">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-10 pb-12">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <div class="inline-flex items-center gap-2 tag px-3 py-1 rounded-full mb-4">LIFESTYLE PLAYBOY</div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
            Moda masculina premium com presen√ßa, confian√ßa e impacto.
          </h1>
          <p class="mt-4 text-slate-300">
            Pe√ßas que destacam atitude e sofistica√ß√£o. Se vista como quem lidera.
          </p>
          <div class="mt-6 flex flex-wrap gap-4">
            <a href="#loja" data-route class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Comprar agora</a>
            <a href="#novidades" data-route class="btn px-5 py-3 rounded-xl pill text-slate-200 hover:text-white">Ver lan√ßamentos</a>
          </div>
          <div class="mt-6 flex items-center gap-4 text-sm text-slate-400">
            <div class="flex items-center gap-2"><span class="star">‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ</span> <span>+320 avalia√ß√µes</span></div>
            <div class="hidden sm:block">‚Ä¢</div>
            <div>Envio r√°pido e rastre√°vel</div>
          </div>
        </div>
        <div class="relative">
          <div class="glass shadow-soft rounded-3xl p-6 ring-accent">
            <div class="grid grid-cols-3 gap-3">
              <!-- Vitrines SVG (substitua por fotos reais depois) -->
              <div class="card-img rounded-2xl h-36 flex items-center justify-center">
                <svg viewBox="0 0 120 120" class="w-24 h-24">
                  <rect x="10" y="10" width="100" height="100" rx="16" fill="#0b1a34"/>
                  <path d="M20 90 L45 40 L75 60 L100 30" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                </svg>
              </div>
              <div class="card-img rounded-2xl h-36 flex items-center justify-center">
                <svg viewBox="0 0 120 120" class="w-24 h-24">
                  <circle cx="60" cy="60" r="42" fill="#0b1a34"/>
                  <path d="M35 70 Q60 30 85 70" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                </svg>
              </div>
              <div class="card-img rounded-2xl h-36 flex items-center justify-center">
                <svg viewBox="0 0 120 120" class="w-24 h-24">
                  <rect x="25" y="25" width="70" height="70" rx="12" fill="#0b1a34"/>
                  <path d="M30 80 L90 80" stroke="#1dd1a1" stroke-width="6"/>
                </svg>
              </div>
              <div class="col-span-3 glass rounded-2xl p-4 flex items-center justify-between">
                <div>
                  <div class="text-sm text-slate-300">Cole√ß√£o destaque</div>
                  <div class="text-lg font-bold" id="homeCollectionName">TFI Black Label</div>
                </div>
                <a href="#loja" data-route class="btn px-4 py-2 rounded-lg cta-gradient font-bold">Ver</a>
              </div>
            </div>
          </div>
          <div class="absolute -top-4 -right-4 tag px-3 py-1 rounded-full pulse">Novo</div>
        </div>
      </div>

      <!-- Faixa de categorias -->
      <div class="mt-12 hidden-scroll overflow-x-auto">
        <div id="categoryChips" class="flex gap-3 min-w-max">
          <!-- chips dinamicos -->
        </div>
      </div>

      <!-- Destaques -->
      <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">Destaques</h2>
        <div id="featuredGrid" class="grid-auto-fit"></div>
      </div>
    </div>
  </section>

  <!-- Loja -->
  <section id="loja" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Filtros -->
        <aside class="md:w-64 glass rounded-2xl p-5 h-max">
          <h3 class="font-bold text-lg mb-3">Filtrar</h3>
          <div class="space-y-4">
            <div>
              <div class="text-sm text-slate-300 mb-2">Categoria</div>
              <select id="filterCategoria" class="w-full bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none">
                <option value="">Todas</option>
              </select>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Tamanho</div>
              <div id="filterTamanho" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Cor</div>
              <div id="filterCor" class="flex flex-wrap gap-2"></div>
            </div>
            <button id="btnLimparFiltros" class="btn w-full mt-2 px-4 py-2 rounded-lg pill">Limpar filtros</button>
          </div>
        </aside>
        <!-- Lista -->
        <div class="flex-1">
          <div class="flex items-center justify-between gap-4 mb-4">
            <h2 class="text-2xl font-bold">Produtos</h2>
            <select id="ordenacao" class="bg-transparent pill px-3 py-2 rounded-lg">
              <option value="relevancia">Relev√¢ncia</option>
              <option value="menor-preco">Menor pre√ßo</option>
              <option value="maior-preco">Maior pre√ßo</option>
              <option value="novidades">Novidades</option>
            </select>
          </div>
          <div id="catalogoGrid" class="grid-auto-fit"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Novidades -->
  <section id="novidades" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Novidades e Promo√ß√µes</h2>
        <span class="badge px-3 py-1 rounded-full">Atualizado semanalmente</span>
      </div>
      <div id="novidadesGrid" class="mt-6 grid-auto-fit"></div>
    </div>
  </section>

  <!-- Favoritos -->
  <section id="favoritos" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="text-center mb-10">
        <h2 class="text-4xl font-extrabold mb-4">Meus Favoritos</h2>
        <p class="text-slate-300">Produtos que voc√™ adorou e salvou para depois</p>
      </div>
      <div id="favoritosGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Produtos favoritos ser√£o renderizados aqui -->
      </div>
      <div id="favoritosVazio" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">üíî</div>
        <h3 class="text-xl font-bold mb-2">Nenhum favorito ainda</h3>
        <p class="text-slate-400 mb-6">Explore nossa loja e adicione produtos aos seus favoritos!</p>
        <a href="#loja" data-route class="btn cta-gradient px-6 py-3 rounded-xl font-bold">Explorar Loja</a>
      </div>
    </div>
  </section>

  <!-- Feedbacks -->
  <section id="feedbacks" class="panel">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Feedbacks de Clientes</h2>
      <div id="feedbackList" class="space-y-4"></div>
      <div class="glass rounded-2xl p-5 mt-6">
        <h3 class="font-bold mb-2">Deixe seu feedback</h3>
        <div class="flex items-center gap-2 mb-3" id="ratingStars">
          <!-- estrelas -->
        </div>
        <textarea id="feedbackText" class="w-full bg-transparent pill p-3 rounded-lg" rows="3" placeholder="Escreva um coment√°rio..."></textarea>
        <div class="mt-3 flex justify-end">
          <button id="btnEnviarFeedback" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Enviar</button>
        </div>
        <p class="hint mt-2">Seu feedback ser√° salvo e exibido para outros clientes.</p>
      </div>
    </div>
  </section>

  <!-- Contato -->
  <section id="contato" class="panel">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Contato e Redes</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-2">Fale com a TFI IMPORTS</h3>
          <div id="chatBox" class="h-56 overflow-y-auto hidden-scroll glass rounded-xl p-3"></div>
          <div class="mt-3 flex gap-2">
            <input id="chatInput" class="flex-1 bg-transparent pill px-3 py-2 rounded-lg" placeholder="Escreva sua mensagem..." />
            <button id="btnChat" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Enviar</button>
          </div>
          <p class="hint mt-2">Nossa equipe responder√° em breve. Atendimento 24/7.</p>
        </div>
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-2">Instagram Oficial</h3>
          <p class="text-slate-300">Siga para ver lan√ßamentos, making-of e ofertas exclusivas.</p>
          <a href="https://instagram.com" target="_blank" rel="noopener" class="btn mt-3 px-4 py-2 rounded-lg pill inline-flex items-center gap-2 hover:text-white">üì∏ Abrir Instagram</a>
          <div class="mt-4 grid grid-cols-3 gap-3">
            <!-- Placeholders de posts -->
            <div class="card-img rounded-xl h-24"></div>
            <div class="card-img rounded-xl h-24"></div>
            <div class="card-img rounded-xl h-24"></div>
          </div>
          <p class="hint mt-2">Pr√©-visualiza√ß√£o ilustrativa. A incorpora√ß√£o direta do feed n√£o √© suportada aqui.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Produto (detalhe) -->
  <section id="produto" class="panel">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
      <button class="btn pill px-3 py-2 rounded-lg mb-4" onclick="navigate('#loja')">‚Üê Voltar</button>
      <div id="produtoWrap" class="grid md:grid-cols-2 gap-6">
        <!-- conteudo dinamico -->
      </div>
    </div>
  </section>

  <!-- Carrinho -->
  <section id="carrinho" class="panel">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Seu Carrinho</h2>
      <div id="cartList" class="space-y-4"></div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-slate-300">Frete calculado no checkout.</div>
        <div class="text-right">
          <div class="text-sm">Subtotal</div>
          <div class="text-2xl font-extrabold" id="cartSubtotal">R$ 0,00</div>
        </div>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button onclick="navigate('#loja')" class="btn px-4 py-2 rounded-lg pill">Continuar comprando</button>
        <a href="#checkout" data-route class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Fechar pedido</a>
      </div>
    </div>
  </section>

  <!-- Checkout -->
  <section id="checkout" class="panel">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Finalizar Compra</h2>
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Endere√ßo e Frete</h3>
          <div class="space-y-4">
            <!-- CEP -->
            <div>
              <label class="block text-sm text-slate-300 mb-2">CEP *</label>
              <div class="flex gap-2">
                <input id="cep" class="bg-transparent pill px-3 py-2 rounded-lg flex-1" placeholder="00000-000" maxlength="9" />
                <button id="btnBuscarCep" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Buscar</button>
              </div>
              <div id="cepStatus" class="text-xs mt-1"></div>
            </div>
            
            <!-- Endere√ßo -->
          <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-2">Logradouro *</label>
                <input id="logradouro" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Rua, Avenida, etc." readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Bairro *</label>
                <input id="bairro" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Bairro" readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Cidade *</label>
                <input id="cidade" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Cidade" readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">UF *</label>
                <input id="uf" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Estado" readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">N√∫mero *</label>
                <input id="numero" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="123" />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Complemento</label>
                <input id="complemento" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Apto, casa, etc." />
              </div>
            </div>
            
            <!-- Bot√£o Calcular Frete -->
            <div class="pt-2">
              <button id="btnCalcFrete" class="btn cta-gradient px-6 py-3 rounded-lg font-bold w-full" disabled>
                Calcular Frete
              </button>
            </div>
          </div>
          <div id="freteOpcoes" class="mt-4 grid sm:grid-cols-2 gap-3"></div>

          <h3 class="font-bold mt-6 mb-3">Pagamento</h3>
          <div class="glass rounded-xl p-6 text-center">
            <div class="mb-4">
              <div class="text-2xl mb-2">üí≥</div>
              <h4 class="font-bold text-lg mb-2">Finalizar Pagamento</h4>
              <p class="text-slate-300 text-sm">
                Escolha sua forma de pagamento preferida no Mercado Pago
              </p>
              </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4 text-xs text-slate-400">
              <div class="flex items-center gap-1">
                <span>üì±</span>
                <span>PIX</span>
            </div>
              <div class="flex items-center gap-1">
                <span>üí≥</span>
                <span>Cart√£o</span>
            </div>
              <div class="flex items-center gap-1">
                <span>üìÑ</span>
                <span>Boleto</span>
              </div>
            </div>
            
            <button id="btnPagar" class="btn cta-gradient w-full px-6 py-3 rounded-lg font-bold text-lg">
              üõí Finalizar Compra
            </button>
          </div>
        </div>
        <div class="glass rounded-2xl p-5 h-max">
          <h3 class="font-bold mb-3">Resumo</h3>
          <div id="resumoCheckout" class="space-y-2"></div>
          <div class="border-t border-white/10 mt-3 pt-3">
            <div class="flex items-center justify-between">
              <span>Frete</span><span id="resFrete">R$ 0,00</span>
            </div>
            <div class="flex items-center justify-between font-extrabold text-lg mt-1">
              <span>Total</span><span id="resTotal">R$ 0,00</span>
            </div>
          </div>
          <button id="btnFinalizar" class="btn cta-gradient w-full mt-4 px-5 py-3 rounded-xl font-bold">Finalizar Pedido</button>
          <p class="hint mt-2">Seu pedido ser√° processado e voc√™ receber√° confirma√ß√£o por email.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Minha Conta -->
  <section id="minha-conta" class="panel">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold gradient-title">Minha Conta</h2>
          <p class="text-slate-300 mt-1">Gerencie seus pedidos e informa√ß√µes pessoais</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="userWelcome" class="text-sm hint">Bem-vindo!</span>
          <button id="btnLogoutUser" class="btn px-4 py-2 rounded-lg pill hover:bg-red-500/20 hover:text-red-300">Sair</button>
        </div>
      </div>
      
      <!-- Resumo da Conta -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Informa√ß√µes do Usu√°rio -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600 flex items-center justify-center">
              <span class="text-xl font-bold text-black">üë§</span>
            </div>
            <div>
              <h3 class="font-bold text-lg">Perfil</h3>
              <p class="text-sm text-slate-300">Suas informa√ß√µes</p>
            </div>
          </div>
          <div id="userInfo" class="space-y-3">
            <div>
              <div class="text-sm text-slate-300">Nome</div>
              <div id="userName" class="font-bold">-</div>
            </div>
            <div>
              <div class="text-sm text-slate-300">Email</div>
              <div id="userEmail" class="font-bold text-sm">-</div>
            </div>
            <div>
              <div class="text-sm text-slate-300">Membro desde</div>
              <div id="userSince" class="font-bold">-</div>
            </div>
          </div>
        </div>
        
        <!-- Estat√≠sticas -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center">
              <span class="text-xl font-bold text-white">üìä</span>
            </div>
            <div>
              <h3 class="font-bold text-lg">Estat√≠sticas</h3>
              <p class="text-sm text-slate-300">Seu hist√≥rico</p>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-slate-300">Total de pedidos:</span>
              <span id="totalOrders" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-300">Valor total:</span>
              <span id="totalSpent" class="font-bold">R$ 0,00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-300">√öltimo pedido:</span>
              <span id="lastOrder" class="font-bold text-sm">-</span>
            </div>
          </div>
        </div>
        
        <!-- A√ß√µes R√°pidas -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-400 to-purple-600 flex items-center justify-center">
              <span class="text-xl font-bold text-white">‚ö°</span>
            </div>
            <div>
              <h3 class="font-bold text-lg">A√ß√µes</h3>
              <p class="text-sm text-slate-300">Acesso r√°pido</p>
            </div>
          </div>
          <div class="space-y-3">
            <a href="#loja" data-route class="btn w-full px-4 py-2 rounded-lg pill text-center block hover:bg-emerald-500/20">
              üõçÔ∏è Continuar Comprando
            </a>
            <a href="#carrinho" data-route class="btn w-full px-4 py-2 rounded-lg pill text-center block hover:bg-blue-500/20">
              üõí Ver Carrinho
            </a>
            <a href="#feedbacks" data-route class="btn w-full px-4 py-2 rounded-lg pill text-center block hover:bg-yellow-500/20">
              ‚≠ê Deixar Feedback
            </a>
          </div>
        </div>
      </div>
      
      <!-- Meus Pedidos -->
      <div class="glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-green-600 flex items-center justify-center">
              <span class="text-lg font-bold text-white">üì¶</span>
            </div>
            <div>
              <h3 class="font-bold text-xl">Meus Pedidos</h3>
              <p class="text-sm text-slate-300">Hist√≥rico de compras</p>
            </div>
          </div>
          <div class="text-sm text-slate-300">
            √öltimos 10 pedidos
          </div>
        </div>
        <div id="userOrders" class="space-y-4">
          <div class="text-slate-300 text-center py-8">
            <div class="text-4xl mb-2">üì¶</div>
            <div class="text-lg font-bold mb-1">Nenhum pedido encontrado</div>
            <div class="text-sm">Fa√ßa sua primeira compra para ver seus pedidos aqui</div>
          </div>
        </div>
      </div>
      
      <!-- Favoritos -->
      <div class="glass rounded-2xl p-6 mt-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-red-400 to-red-600 flex items-center justify-center">
            <span class="text-lg font-bold text-white">‚ù§Ô∏è</span>
          </div>
          <div>
            <h3 class="font-bold text-xl">Produtos Favoritos</h3>
            <p class="text-sm text-slate-300">Seus produtos preferidos</p>
          </div>
        </div>
        <div id="userFavorites" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-slate-300 text-center py-12">
            <div class="text-4xl mb-2">‚ù§Ô∏è</div>
            <div class="text-lg font-bold mb-1">Nenhum favorito ainda</div>
            <div class="text-sm">Adicione produtos aos favoritos para v√™-los aqui</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin -->
  <section id="admin" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Painel Admin</h2>
        <div class="flex items-center gap-2">
          <span id="authState" class="text-sm hint">N√£o autenticado</span>
          <button id="btnAdminLogin" class="btn px-4 py-2 rounded-lg pill">Entrar</button>
          <button id="btnLogout" class="btn px-4 py-2 rounded-lg pill hidden">Sair</button>
        </div>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 mt-6">
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Cadastrar Produto</h3>
          <div class="grid grid-cols-2 gap-3">
            <input id="admNome" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Nome do produto" />
            <select id="admCategoria" class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none col-span-2"></select>
            <input id="admPreco" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Pre√ßo (R$)" />
            <input id="admPromo" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Pre√ßo promocional (opcional)" />
            <input id="admImagem" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="URL da imagem (opcional)" />
            <input id="admCores" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Cores (ex.: preto,branco,azul)" />
            <input id="admTamanhos" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Tamanhos (ex.: P,M,G,GG)" />
            <textarea id="admDesc" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" rows="3" placeholder="Descri√ß√£o curta"></textarea>
            <input id="admComposicao" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Composi√ß√£o (ex.: 100% Algod√£o)" />
            <input id="admEstilo" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Estilo (ex.: TFI Signature)" />
            <input id="admEnvio" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Envio (ex.: R√°pido e rastre√°vel)" />
            <button id="btnSalvarProduto" class="btn cta-gradient px-4 py-2 rounded-lg font-bold col-span-2">Salvar Produto</button>
          </div>
          <p class="hint mt-2">Os produtos s√£o salvos no Firestore e aparecem automaticamente na loja.</p>
        </div>
        <div class="glass rounded-2xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold">Produtos</h3>
            <div class="text-sm text-slate-400">
              Total: <span id="totalProducts">0</span> produtos
            </div>
          </div>
          <div id="adminLista" class="space-y-3 max-h-96 overflow-y-auto hidden-scroll"></div>
        </div>
      </div>
      
      <!-- Se√ß√£o Cole√ß√£o Destaque -->
      <div class="mt-6 glass rounded-2xl p-5">
        <h3 class="font-bold mb-3">Cole√ß√£o Destaque</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <div class="mb-4">
              <label class="text-sm text-slate-300 mb-2 block">Nome da Cole√ß√£o</label>
              <input id="featuredCollectionName" class="w-full bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none" placeholder="Ex: TFI Black Label" value="TFI Black Label" />
            </div>
            <div class="mb-4">
              <label class="text-sm text-slate-300 mb-2 block">Produtos em Destaque (m√°x. 3)</label>
              <div id="featuredProductsList" class="space-y-2 max-h-48 overflow-y-auto hidden-scroll">
                <!-- Produtos ser√£o carregados aqui -->
              </div>
            </div>
            <button id="btnSaveFeatured" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Salvar Cole√ß√£o</button>
          </div>
          <div>
            <div class="text-sm text-slate-300 mb-2">Preview da Cole√ß√£o</div>
            <div class="glass rounded-xl p-4 border border-emerald-400/30">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-semibold">Cole√ß√£o destaque</span>
                <span class="badge text-xs">Novo</span>
              </div>
              <div class="text-lg font-bold mb-2" id="previewCollectionName">TFI Black Label</div>
              <div class="text-sm text-slate-400 mb-3">Produtos selecionados: <span id="previewProductCount">0</span></div>
              <button class="btn pill px-3 py-1 text-xs">Ver</button>
            </div>
          </div>
        </div>
      </div>


        </div>
  </section>

  <!-- Modal de Escolha do Tipo de Pe√ßa -->
  <div id="tipoPecaModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50">
    <div class="glass rounded-2xl p-6 max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Escolha o tipo da pe√ßa</h3>
        <button id="closeTipoPecaModal" class="text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-3">
        <button class="w-full btn pill px-4 py-3 text-left" data-tipo="ver">
          <div class="font-semibold">Ver produto</div>
          <div class="text-sm text-slate-400">Visualizar detalhes completos</div>
        </button>
        <button class="w-full btn pill px-4 py-3 text-left" data-tipo="adicionar">
          <div class="font-semibold">Adicionar ao carrinho</div>
          <div class="text-sm text-slate-400">Adicionar diretamente ao carrinho</div>
        </button>
    </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50 p-4">
    <div class="glass rounded-2xl p-4 sm:p-6 max-w-md w-full mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg sm:text-xl font-bold">Entrar na TFI IMPORTS</h3>
        <button id="closeLogin" class="btn pill px-3 py-1 rounded-lg text-lg">‚úï</button>
      </div>
      
      <!-- Login com Email/Senha -->
      <div id="emailLoginForm" class="space-y-4">
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="loginEmail" type="email" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="seu@email.com" />
      </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Senha</label>
          <input id="loginPassword" type="password" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="Sua senha" />
    </div>
        <button id="btnEmailLogin" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold text-sm sm:text-base">Entrar</button>
        <button id="btnShowRegister" class="btn pill w-full px-4 py-2 rounded-lg text-sm sm:text-base">Criar conta</button>
  </div>
      
      <!-- Registro com Email/Senha -->
      <div id="registerForm" class="space-y-4 hidden">
        <div>
          <label class="block text-sm text-slate-300 mb-2">Nome</label>
          <input id="registerName" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="Seu nome completo" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="registerEmail" type="email" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="seu@email.com" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Senha</label>
          <input id="registerPassword" type="password" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="M√≠nimo 6 caracteres" />
        </div>
        <button id="btnEmailRegister" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold text-sm sm:text-base">Criar Conta</button>
        <button id="btnShowLogin" class="btn pill w-full px-4 py-2 rounded-lg text-sm sm:text-base">J√° tenho conta</button>
      </div>
      
      <!-- Divisor -->
      <div class="flex items-center my-4">
        <div class="flex-1 border-t border-white/20"></div>
        <span class="px-3 text-sm text-slate-400">ou</span>
        <div class="flex-1 border-t border-white/20"></div>
      </div>
      
      <!-- Login com Google -->
      <button id="btnGoogleLogin" class="btn pill w-full px-4 py-3 rounded-lg flex items-center justify-center gap-3 text-sm sm:text-base">
        <svg width="20" height="20" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Entrar com Google
      </button>
      
      <div class="mt-4 text-xs text-center hint">
        Ao entrar, voc√™ concorda com nossos termos de uso.
      </div>
    </div>
  </div>



  <!-- Footer -->
  <footer class="mt-16 border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid md:grid-cols-3 gap-6">
      <div>
        <div class="text-lg font-extrabold gradient-title">TFI IMPORTS</div>
        <p class="text-slate-300 mt-2">Estilo premium com atitude. Atendimento direto no site.</p>
      </div>
      <div>
        <div class="font-bold mb-2">Categorias</div>
        <div id="footerCats" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <div class="font-bold mb-2">Links</div>
        <div class="flex flex-col gap-1">
          <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
          <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
          <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
          <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
          <span class="text-xs hint mt-2">¬© <span id="year"></span> TFI IMPORTS. Todos os direitos reservados.</span>
          <div class="text-xs hint mt-2">
            Desenvolvido por <a href="https://agenciaelevare.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:text-emerald-300 transition-colors">Ag√™ncia Elevare</a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    // Importar fun√ß√µes de seguran√ßa
    import { checkRateLimit, sanitizeText, validateProduct } from './security.js';
    
    // Importar servi√ßos de integra√ß√£o
    import { asaasService } from './asaas.js';
    import { melhorEnvioService } from './melhor-envio.js';
    import { OrderManager } from './order-manager.js';
    import { validateConfig } from './api-config.js';
    
    // Estado global (local)
    const state = {
      user: null,
      adminEmail: 'admin@tfimports.com.br', // Email do administrador
      favoritos: [], // Array de IDs dos produtos favoritos
      featuredCollection: {
        name: 'TFI Black Label',
        products: [] // Array de IDs dos produtos em destaque (m√°x. 3)
      },
      categorias: [
        "Camisetas","Cal√ßas","Bermudas de linho","Bermudas de sarja","Cueca premium",
        "Camiseta dry fit","Camisa peruana","Camisa polo","Regata USA","Meias","Bermuda high"
      ],
      produtos: [
        {
          id: "p1",
          nome: "Camiseta Black Premium",
          categoria: "Camisetas",
          preco: 199.9,
          promo: 159.9,
          cores: ["preto","branco"],
          tamanhos: ["P","M","G","GG"],
          novas: true,
          destaque: true,
          descricao: "Camiseta premium em algod√£o eg√≠pcio. Toque macio e caimento perfeito.",
          composicao: "100% algod√£o eg√≠pcio",
          estilo: "Casual sofisticado",
          imagens: ["svg"]
        },
        {
          id: "p2",
          nome: "Bermuda de Linho Azul",
          categoria: "Bermudas de linho",
          preco: 249.9,
          promo: null,
          cores: ["azul","areia"],
          tamanhos: ["P","M","G"],
          novas: true,
          destaque: true,
          descricao: "Leve, refrescante e elegante. Ideal para clima quente.",
          composicao: "55% linho, 45% algod√£o",
          estilo: "Summer classy",
          imagens: ["svg"]
        },
        {
          id: "p3",
          nome: "Cueca Premium Comfort",
          categoria: "Cueca premium",
          preco: 69.9,
          promo: 59.9,
          cores: ["preto","cinza"],
          tamanhos: ["M","G","GG"],
          novas: false,
          destaque: true,
          descricao: "Suporte e maciez com respirabilidade para o dia todo.",
          composicao: "Modal com elastano",
          estilo: "Conforto ativo",
          imagens: ["svg"]
        },
        {
          id: "p4",
          nome: "Camisa Polo TFI",
          categoria: "Camisa polo",
          preco: 229.9,
          promo: 199.9,
          cores: ["preto","azul-marinho","branco"],
          tamanhos: ["P","M","G","GG"],
          novas: false,
          destaque: false,
          descricao: "Textura premium e acabamento impec√°vel.",
          composicao: "Algod√£o Pima",
          estilo: "Smart casual",
          imagens: ["svg"]
        },
        {
          id: "p5",
          nome: "Regata USA Cut",
          categoria: "Regata USA",
          preco: 119.9,
          promo: 99.9,
          cores: ["preto","verde"],
          tamanhos: ["P","M","G"],
          novas: true,
          destaque: false,
          descricao: "Corte atl√©tico com visual urbano.",
          composicao: "Poli√©ster com elastano",
          estilo: "Athleisure",
          imagens: ["svg"]
        }
      ],
      carrinho: [],
      freteSelecionado: null
    };

    // Utilidades
    const fmt = v => v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    
    // Verificar se usu√°rio √© admin
    function isAdmin() {
      return state.user && state.user.email === state.adminEmail;
    }
    
    // Verificar se h√° dados de usu√°rio salvos localmente (fallback)
    function checkLocalUserData() {
      try {
        const localUser = localStorage.getItem('tfi_user');
        if (localUser && !state.user) {
          const userData = JSON.parse(localUser);
          // S√≥ usar dados locais se o Firebase n√£o estiver dispon√≠vel
          if (!auth) {
            state.user = userData;
            updateAuthUI();
            console.log('Usando dados de usu√°rio salvos localmente');
          }
        }
      } catch (error) {
        console.error('Erro ao verificar dados locais do usu√°rio:', error);
      }
    }
    
    // Salvar dados do usu√°rio localmente como backup
    function saveLocalUserData() {
      if (state.user) {
        try {
          localStorage.setItem('tfi_user', JSON.stringify({
            uid: state.user.uid,
            email: state.user.email,
            displayName: state.user.displayName
          }));
        } catch (error) {
          console.error('Erro ao salvar dados locais do usu√°rio:', error);
        }
      } else {
        localStorage.removeItem('tfi_user');
      }
    }

    // Navega√ß√£o SPA
    function navigate(hash) {
      window.location.hash = hash;
    }
    function applyRoute() {
      const hash = window.location.hash || "#home";
      qsa('[data-route]').forEach(a => a.classList.toggle('nav-active', a.getAttribute('href') === hash));
      qsa('.panel').forEach(p => p.classList.remove('active'));
      const id = hash.replace('#','');
      
      // Fechar menu mobile ao navegar
      qs('#mobileNav').classList.add('hidden');
      
      // Proteger painel admin - apenas admin pode acessar
      if (id === 'admin') {
        if (!state.user) {
          toast('Fa√ßa login para acessar o painel administrativo.');
          navigate('#home');
          return;
        }
        if (!isAdmin()) {
          toast('Acesso negado. Apenas administradores podem acessar esta √°rea.');
          navigate('#home');
          return;
        }
      }
      
      // Proteger minha conta - apenas usu√°rios logados
      if (id === 'minha-conta' && !state.user) {
        toast('Fa√ßa login para acessar sua conta.');
        navigate('#home');
        return;
      }
      
      const panel = qs('#'+id);
      if (panel) panel.classList.add('active');
      if (id === 'produto') renderProdutoDetalhe();
      if (id === 'carrinho') renderCarrinho();
      if (id === 'favoritos') renderFavoritos();
      if (id === 'checkout') renderCheckoutResumo();
      if (id === 'minha-conta') renderMinhaConta();
    }
    window.addEventListener('hashchange', applyRoute);

    // Header behaviors
    qs('#btnMenu').addEventListener('click', () => {
      qs('#mobileNav').classList.toggle('hidden');
    });

    // Render categorias chips/footer
    function renderChips() {
      const chips = qs('#categoryChips');
      chips.innerHTML = '';
      state.categorias.forEach(cat => {
        const a = document.createElement('a');
        a.href = '#loja';
        a.setAttribute('data-route','');
        a.className = 'pill px-4 py-2 rounded-full hover:text-emerald-300';
        a.textContent = cat;
        a.addEventListener('click', () => {
          qs('#filterCategoria').value = cat;
          filterAndRenderCatalog();
        });
        chips.appendChild(a);
      });
      const footerCats = qs('#footerCats');
      footerCats.innerHTML = '';
      state.categorias.slice(0,6).forEach(cat => {
        const span = document.createElement('span');
        span.className = 'pill px-3 py-1 rounded-full text-sm';
        span.textContent = cat;
        footerCats.appendChild(span);
      });
    }

    // Produto card com imagem ou placeholder
    function produtoThumb(produto) {
      if (produto.imagem) {
        return `
          <div class="card-img rounded-2xl aspect-[4/3] overflow-hidden">
            <img src="${produto.imagem}" alt="${produto.nome}" class="w-full h-full object-cover" 
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-full h-full flex items-center justify-center bg-gray-800" style="display:none;">
              <svg viewBox="0 0 140 100" class="w-24 h-24">
                <rect x="10" y="10" width="120" height="80" rx="12" fill="#0b1a34"/>
                <path d="M20 75 L55 35 L85 55 L120 25" stroke="#1dd1a1" stroke-width="5" fill="none"/>
              </svg>
            </div>
          </div>`;
      } else {
      return `
        <div class="card-img rounded-2xl aspect-[4/3] grid place-items-center">
          <svg viewBox="0 0 140 100" class="w-24 h-24">
            <rect x="10" y="10" width="120" height="80" rx="12" fill="#0b1a34"/>
            <path d="M20 75 L55 35 L85 55 L120 25" stroke="#1dd1a1" stroke-width="5" fill="none"/>
          </svg>
        </div>`;
      }
    }

    // Destaques
    function renderDestaques() {
      const grid = qs('#featuredGrid');
      grid.innerHTML = '';
      
      // Usar produtos da cole√ß√£o destaque personalizada
      const featuredProducts = state.featuredCollection.products
        .map(id => state.produtos.find(p => p.id === id))
        .filter(Boolean)
        .slice(0, 3);
      
      // Se n√£o houver produtos na cole√ß√£o, usar produtos com destaque
      const productsToShow = featuredProducts.length > 0 ? featuredProducts : state.produtos.filter(p => p.destaque).slice(0,6);
      
      productsToShow.forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs">Novo</span>' : ''}
            </div>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      grid.addEventListener('click', async e => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') { openProduto(id); }
        if (act === 'add') { openTipoPecaModal(id); }
        if (act === 'favoritar') { await toggleFavorito(id); }
      });
    }

    // Loja: filtros
    function initFilters() {
      const sel = qs('#filterCategoria');
      state.categorias.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
      const sizes = ["PP","P","M","G","GG","XG"];
      const wrapT = qs('#filterTamanho');
      sizes.forEach(t => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill text-sm';
        b.textContent = t;
        b.addEventListener('click', () => {
          b.classList.toggle('badge');
          filterAndRenderCatalog();
        });
        wrapT.appendChild(b);
      });
      const cores = ["preto","branco","azul","verde","cinza","areia"];
      const wrapC = qs('#filterCor');
      cores.forEach(c => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill text-sm capitalize';
        b.textContent = c;
        b.addEventListener('click', () => {
          b.classList.toggle('badge');
          filterAndRenderCatalog();
        });
        wrapC.appendChild(b);
      });
      qs('#btnLimparFiltros').addEventListener('click', () => {
        qs('#filterCategoria').value = '';
        qsa('#filterTamanho button, #filterCor button').forEach(b => b.classList.remove('badge'));
        filterAndRenderCatalog();
      });
      qs('#ordenacao').addEventListener('change', filterAndRenderCatalog);
    }
    function filterAndRenderCatalog() {
      const grid = qs('#catalogoGrid');
      const cat = qs('#filterCategoria').value;
      const sizesSel = qsa('#filterTamanho button.badge').map(b => b.textContent.trim());
      const coresSel = qsa('#filterCor button.badge').map(b => b.textContent.trim());
      let arr = [...state.produtos];
      if (cat) arr = arr.filter(p => p.categoria === cat);
      if (sizesSel.length) arr = arr.filter(p => p.tamanhos.some(t => sizesSel.includes(t)));
      if (coresSel.length) arr = arr.filter(p => p.cores.some(c => coresSel.includes(c)));
      const ord = qs('#ordenacao').value;
      if (ord === 'menor-preco') arr.sort((a,b)=>(a.promo ?? a.preco) - (b.promo ?? b.preco));
      if (ord === 'maior-preco') arr.sort((a,b)=>(b.promo ?? b.preco) - (a.promo ?? a.preco));
      if (ord === 'novidades') arr.sort((a,b)=> (b.novas?-1:1));
      grid.innerHTML = '';
      arr.forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <h3 class="font-bold">${p.nome}</h3>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Remover event listeners antigos e adicionar novo
      grid.replaceWith(grid.cloneNode(true));
      const newGrid = qs('#catalogoGrid');
      newGrid.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') openProduto(id);
        if (act === 'add') addToCart(id);
      });
    }

    // Novidades
    function renderNovidades() {
      const grid = qs('#novidadesGrid');
      grid.innerHTML = '';
      state.produtos.filter(p=>p.novas || p.promo).slice(0,8).forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.promo ? '<span class="badge px-2 py-1 rounded-full text-xs">Promo</span>' : '<span class="badge px-2 py-1 rounded-full text-xs">Lan√ßamento</span>'}
            </div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Remover event listeners antigos e adicionar novo
      grid.replaceWith(grid.cloneNode(true));
      const newGrid = qs('#novidadesGrid');
      newGrid.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') openProduto(id);
        if (act === 'add') addToCart(id);
      });
    }

    // Produto detalhe
    let currentProdutoId = null;
    function openProduto(id) {
      currentProdutoId = id;
      navigate('#produto');
    }
    function renderProdutoDetalhe() {
      const p = state.produtos.find(x=>x.id===currentProdutoId) || state.produtos[0];
      const wrap = qs('#produtoWrap');
      wrap.innerHTML = `
        <div class="glass rounded-2xl p-5">
          <div class="rounded-xl card-img aspect-square grid place-items-center overflow-hidden">
            ${p.imagem ? 
              `<img src="${p.imagem}" alt="${p.nome}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <div class="w-full h-full flex items-center justify-center text-gray-400" style="display:none;">
                 <svg viewBox="0 0 160 160" class="w-40 h-40">
                   <rect x="15" y="15" width="130" height="130" rx="16" fill="#0b1a34"/>
                   <path d="M30 120 L70 60 L110 80 L135 45" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                 </svg>
               </div>` :
              `<svg viewBox="0 0 160 160" class="w-40 h-40">
                <rect x="15" y="15" width="130" height="130" rx="16" fill="#0b1a34"/>
                <path d="M30 120 L70 60 L110 80 L135 45" stroke="#1dd1a1" stroke-width="6" fill="none"/>
              </svg>`
            }
          </div>
        </div>
        <div>
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-extrabold">${p.nome}</h1>
            ${p.novas ? '<span class="badge px-3 py-1 rounded-full">Novo</span>' : ''}
          </div>
          <div class="text-sm hint mt-1">${p.categoria}</div>
          <div class="mt-3 flex items-center gap-3">
            <div class="text-3xl font-extrabold">${fmt(p.promo ?? p.preco)}</div>
            ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
          </div>
          <p class="mt-4 text-slate-300">${p.descricao}</p>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm text-slate-300 mb-2">Cor</div>
              <div id="selCores" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Tamanho</div>
              <div id="selTamanhos" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div class="mt-5 flex gap-3">
            <button id="btnAddDetail" class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Adicionar ao carrinho</button>
            <button class="btn px-5 py-3 rounded-xl pill" onclick="navigate('#carrinho')">Ver carrinho</button>
          </div>
          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Composi√ß√£o</div><div class="hint">${p.composicao}</div></div>
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Estilo</div><div class="hint">${p.estilo}</div></div>
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Envio</div><div class="hint">${p.envio || 'R√°pido e rastre√°vel'}</div></div>
          </div>
        </div>
      `;
      const cores = qs('#selCores'); const tams = qs('#selTamanhos');
      p.cores.forEach(c => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill capitalize';
        b.textContent = c;
        b.addEventListener('click', () => {
          qsa('#selCores button').forEach(x => x.classList.remove('badge')); b.classList.add('badge');
        });
        cores.appendChild(b);
      });
      p.tamanhos.forEach(t => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill';
        b.textContent = t;
        b.addEventListener('click', () => {
          qsa('#selTamanhos button').forEach(x => x.classList.remove('badge')); b.classList.add('badge');
        });
        tams.appendChild(b);
      });
      qs('#btnAddDetail').onclick = () => {
        const cor = (qsa('#selCores button.badge')[0]||{}).textContent || p.cores[0];
        const tam = (qsa('#selTamanhos button.badge')[0]||{}).textContent || p.tamanhos[0];
        addToCart(p.id, cor, tam, 1);
      };
    }

    // Favoritos
    async function loadFavoritos() {
      if (state.user && db) {
        // Carregar favoritos do usu√°rio do Firestore
        try {
          const userFavs = await db.collection('usuarios').doc(state.user.uid).get();
          if (userFavs.exists) {
            state.favoritos = userFavs.data().favoritos || [];
          } else {
            state.favoritos = [];
          }
        } catch (error) {
          console.error('Erro ao carregar favoritos:', error);
          state.favoritos = [];
        }
      } else {
        // Fallback para localStorage se n√£o estiver logado
        try { state.favoritos = JSON.parse(localStorage.getItem('tfi_favoritos')||'[]'); } catch { state.favoritos = []; }
      }
      updateFavoritosUI();
    }
    
    async function saveFavoritos() {
      if (state.user && db) {
        // Salvar favoritos do usu√°rio no Firestore
        try {
          await db.collection('usuarios').doc(state.user.uid).set({
            favoritos: state.favoritos
          }, { merge: true });
        } catch (error) {
          console.error('Erro ao salvar favoritos:', error);
        }
      } else {
        // Fallback para localStorage se n√£o estiver logado
        localStorage.setItem('tfi_favoritos', JSON.stringify(state.favoritos));
      }
      updateFavoritosUI();
    }
    
    async function toggleFavorito(id) {
      const index = state.favoritos.indexOf(id);
      if (index > -1) {
        state.favoritos.splice(index, 1);
      } else {
        state.favoritos.push(id);
      }
      await saveFavoritos();
    }
    function isFavorito(id) {
      return state.favoritos.includes(id);
    }
    function updateFavoritosUI() {
      // Atualizar bot√µes de favorito em todos os cards
      qsa('.favorito-btn').forEach(btn => {
        const id = btn.getAttribute('data-id');
        const svg = btn.querySelector('svg');
        if (isFavorito(id)) {
          btn.classList.add('badge');
          svg.setAttribute('fill', 'currentColor');
        } else {
          btn.classList.remove('badge');
          svg.setAttribute('fill', 'none');
        }
      });
    }
    function renderFavoritos() {
      const grid = qs('#favoritosGrid');
      const vazio = qs('#favoritosVazio');
      
      // Verificar se usu√°rio est√° logado
      if (!state.user) {
        grid.innerHTML = '';
        vazio.innerHTML = `
          <div class="text-6xl mb-4">üîí</div>
          <h3 class="text-xl font-bold mb-2">Fa√ßa login para ver seus favoritos</h3>
          <p class="text-slate-400 mb-6">Entre na sua conta para acessar seus produtos favoritos!</p>
          <button onclick="openLoginModal()" class="btn cta-gradient px-6 py-3 rounded-xl font-bold">Fazer Login</button>
        `;
        vazio.classList.remove('hidden');
        return;
      }
      
      if (state.favoritos.length === 0) {
        grid.innerHTML = '';
        vazio.innerHTML = `
          <div class="text-6xl mb-4">üíî</div>
          <h3 class="text-xl font-bold mb-2">Nenhum favorito ainda</h3>
          <p class="text-slate-400 mb-6">Explore nossa loja e adicione produtos aos seus favoritos!</p>
          <a href="#loja" data-route class="btn cta-gradient px-6 py-3 rounded-xl font-bold">Explorar Loja</a>
        `;
        vazio.classList.remove('hidden');
        return;
      }
      
      vazio.classList.add('hidden');
      grid.innerHTML = '';
      
      state.favoritos.forEach(id => {
        const p = state.produtos.find(x => x.id === id);
        if (!p) return;
        
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs">Novo</span>' : ''}
            </div>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      
      // Adicionar event listeners para os bot√µes na p√°gina de favoritos
      grid.addEventListener('click', async e => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') { openProduto(id); }
        if (act === 'add') { openTipoPecaModal(id); }
        if (act === 'favoritar') { await toggleFavorito(id); }
      });
    }

    // Carrinho
    function loadCart() {
      try { state.carrinho = JSON.parse(localStorage.getItem('tfi_cart')||'[]'); } catch { state.carrinho = []; }
      updateCartCount();
    }
    function saveCart() {
      localStorage.setItem('tfi_cart', JSON.stringify(state.carrinho));
      updateCartCount();
    }
    function updateCartCount() {
      qs('#cartCount').textContent = state.carrinho.reduce((s,i)=>s+i.qtd,0);
    }
    function addToCart(id, cor=null, tam=null, qtd=1) {
      const p = state.produtos.find(x=>x.id===id); if (!p) return;
      const key = id + '|' + (cor||p.cores[0]) + '|' + (tam||p.tamanhos[0]);
      const found = state.carrinho.find(x=>x.key===key);
      if (found) found.qtd += qtd;
      else state.carrinho.push({ key, id, nome: p.nome, preco: p.promo ?? p.preco, cor: cor||p.cores[0], tam: tam||p.tamanhos[0], qtd });
      saveCart();
      // toast simples
      const t = document.createElement('div');
      t.className='fixed bottom-6 right-6 glass rounded-xl p-3'; t.textContent='Adicionado ao carrinho';
      document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
    }
    function renderCarrinho() {
      const list = qs('#cartList'); list.innerHTML='';
      if (!state.carrinho.length){
        list.innerHTML = '<div class="glass rounded-xl p-5 text-slate-300">Seu carrinho est√° vazio.</div>';
      } else {
        state.carrinho.forEach((i, idx) => {
          const row = document.createElement('div');
          row.className = 'glass rounded-2xl p-4 flex items-center justify-between gap-3';
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="card-img rounded-xl w-20 h-16"></div>
              <div>
                <div class="font-bold">${i.nome}</div>
                <div class="hint text-sm">Cor: ${i.cor} ‚Ä¢ Tam: ${i.tam}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="pill px-2 py-1 rounded-lg">${fmt(i.preco)}</div>
              <div class="flex items-center gap-2">
                <button class="btn pill px-2 py-1 rounded-lg" data-idx="${idx}" data-act="menos">‚àí</button>
                <div class="w-8 text-center">${i.qtd}</div>
                <button class="btn pill px-2 py-1 rounded-lg" data-idx="${idx}" data-act="mais">+</button>
              </div>
              <button class="btn px-3 py-2 rounded-lg pill" data-idx="${idx}" data-act="rm">Remover</button>
            </div>
          `;
          list.appendChild(row);
        });
        list.onclick = (e) => {
          const b = e.target.closest('button'); if(!b) return;
          const idx = +b.getAttribute('data-idx'); const act = b.getAttribute('data-act');
          if (act==='mais') state.carrinho[idx].qtd++;
          if (act==='menos') state.carrinho[idx].qtd = Math.max(1, state.carrinho[idx].qtd-1);
          if (act==='rm') state.carrinho.splice(idx,1);
          saveCart(); renderCarrinho();
        };
      }
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      qs('#cartSubtotal').textContent = fmt(subtotal);
    }

    // Checkout
    function renderCheckoutResumo() {
      const box = qs('#resumoCheckout'); box.innerHTML='';
      if (!state.carrinho.length) {
        box.innerHTML = '<div class="hint">Seu carrinho est√° vazio.</div>';
      } else {
        state.carrinho.forEach(i => {
          const line = document.createElement('div');
          line.className = 'flex items-center justify-between';
          line.innerHTML = `<span class="text-slate-300">${i.nome} (${i.qtd})</span><span>${fmt(i.preco*i.qtd)}</span>`;
          box.appendChild(line);
        });
      }
      updateTotals();
    }
    function updateTotals() {
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      const frete = state.freteSelecionado?.preco || 0;
      qs('#resFrete').textContent = fmt(frete);
      qs('#resTotal').textContent = fmt(subtotal + frete);
    }
        // Formata√ß√£o autom√°tica do CEP
    qs('#cep').addEventListener('input', (e) => {
      const cep = e.target.value.replace(/\D/g, '');
      if (cep.length <= 8) {
        e.target.value = melhorEnvioService.formatCEP(cep);
      }
      
      // Limpar status quando usu√°rio digita
      qs('#cepStatus').textContent = '';
      qs('#btnCalcFrete').disabled = true;
    });

    // Buscar CEP
    qs('#btnBuscarCep').addEventListener('click', async () => {
      const cepInput = qs('#cep');
      const cep = cepInput.value.replace(/\D/g, '');
      const statusDiv = qs('#cepStatus');
      
      if (cep.length !== 8) {
        statusDiv.textContent = 'CEP deve ter 8 d√≠gitos';
        statusDiv.className = 'text-xs mt-1 text-red-400';
        return;
      }
      
      statusDiv.textContent = 'Buscando CEP...';
      statusDiv.className = 'text-xs mt-1 text-blue-400';
      qs('#btnBuscarCep').disabled = true;
      
      try {
        const result = await melhorEnvioService.validateCEP(cep);
        
        if (result.success) {
          // Preencher campos automaticamente
          qs('#logradouro').value = result.logradouro;
          qs('#bairro').value = result.bairro;
          qs('#cidade').value = result.cidade;
          qs('#uf').value = result.uf;
          
          // Formatar CEP
          cepInput.value = result.cep;
          
          statusDiv.textContent = 'CEP encontrado! Preencha o n√∫mero e complemento.';
          statusDiv.className = 'text-xs mt-1 text-green-400';
          
          // Habilitar bot√£o de calcular frete
          qs('#btnCalcFrete').disabled = false;
          
          // Focar no campo n√∫mero
          qs('#numero').focus();
          
        } else {
          statusDiv.textContent = result.error;
          statusDiv.className = 'text-xs mt-1 text-red-400';
        }
        
      } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        statusDiv.textContent = 'Erro ao buscar CEP. Tente novamente.';
        statusDiv.className = 'text-xs mt-1 text-red-400';
      } finally {
        qs('#btnBuscarCep').disabled = false;
      }
    });

    // Buscar CEP ao pressionar Enter
    qs('#cep').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        qs('#btnBuscarCep').click();
      }
    });

    // Validar endere√ßo completo antes de calcular frete
    qs('#btnCalcFrete').addEventListener('click', async () => {
      const op = qs('#freteOpcoes'); 
      op.innerHTML='<div class="hint text-center py-4">Calculando frete...</div>';
      
      // Coletar dados do endere√ßo
      const addressData = {
        cep: qs('#cep').value.replace(/\D/g, ''),
        logradouro: qs('#logradouro').value,
        bairro: qs('#bairro').value,
        cidade: qs('#cidade').value,
        uf: qs('#uf').value,
        numero: qs('#numero').value,
        complemento: qs('#complemento').value
      };
      
      // Validar endere√ßo
      const validation = melhorEnvioService.validateAddress(addressData);
      if (!validation.isValid) {
        op.innerHTML = `<div class="hint text-center py-4">Erro: ${validation.errors.join(', ')}</div>`;
        return;
      }
      
      try {
        // Calcular frete com Melhor Envio
        const shippingData = {
          cepDestino: addressData.cep,
          produtos: state.carrinho.map(item => ({
            id: item.id,
            nome: item.nome,
            preco: item.preco,
            quantidade: item.qtd,
            peso: 0.3 // Peso padr√£o em kg
          })),
          pesoTotal: state.carrinho.reduce((total, item) => total + (0.3 * item.qtd), 0)
        };
        
        const result = await melhorEnvioService.calculateShipping(shippingData);
        
        if (result.success && result.options.length > 0) {
          op.innerHTML = '';
          
          result.options.forEach(option => {
        const d = document.createElement('label');
            d.className = 'glass rounded-xl p-3 flex items-center justify-between cursor-pointer hover:ring-2 hover:ring-emerald-400/40';
            d.innerHTML = `
              <div>
                <div class="font-bold">${option.name}</div>
                <div class="hint text-sm">${option.company} ‚Ä¢ ${option.delivery_time} dias √∫teis</div>
              </div>
              <div class="flex items-center gap-3">
                <div class="font-extrabold">${fmt(option.price)}</div>
                <input type="radio" name="frete" value="${option.id}" data-company="${option.company_id}">
              </div>
            `;
        op.appendChild(d);
      });
          
      op.onclick = (e) => {
            const r = e.target.closest('input[type=radio]'); 
            if (!r) return;
            
            const selectedOption = result.options.find(opt => opt.id === r.value);
            state.freteSelecionado = {
              id: selectedOption.id,
              nome: selectedOption.name,
              empresa: selectedOption.company,
              preco: selectedOption.price,
              prazo: `${selectedOption.delivery_time} dias √∫teis`,
              company_id: selectedOption.company_id
            };
            
            // Salvar endere√ßo completo no estado
            state.enderecoCompleto = addressData;
            
            updateTotals();
            toast('Frete selecionado!');
          };
          
        } else {
          op.innerHTML = '<div class="hint text-center py-4">N√£o foi poss√≠vel calcular o frete para este endere√ßo.</div>';
        }
        
      } catch (error) {
        console.error('Erro ao calcular frete:', error);
        op.innerHTML = '<div class="hint text-center py-4">Erro ao calcular frete. Tente novamente.</div>';
      }
    });

    // Pagamento
    qs('#btnPagar').addEventListener('click', async () => {
      await processPayment();
    });
    qs('#btnFinalizar').addEventListener('click', async () => {
      if (!state.carrinho.length) { toast('Adicione produtos antes de finalizar.'); return; }
      
      // Verificar se usu√°rio est√° logado
      if (!state.user) {
        toast('Fa√ßa login para finalizar o pedido.');
        openLoginModal();
        return;
      }
      
      try {
        // Calcular totais
        const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
        const frete = state.freteSelecionado?.preco || 0;
        const total = subtotal + frete;
        
        // Salvar pedido no Firestore
        const pedidoData = {
          itens: state.carrinho.map(item => ({
            id: item.id,
            nome: item.nome,
            preco: item.preco,
            cor: item.cor,
            tamanho: item.tam,
            quantidade: item.qtd
          })),
          subtotal: subtotal,
          frete: frete,
          total: total,
          status: 'pendente',
          criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
          userId: state.user.uid,
          email: state.user.email,
          nomeUsuario: state.user.displayName || 'Usu√°rio',
          endereco: {
            cep: qs('#cep').value || '',
            cidade: qs('#cidade').value || '',
            uf: qs('#uf').value || ''
          },
          freteSelecionado: state.freteSelecionado ? {
            nome: state.freteSelecionado.nome,
            prazo: state.freteSelecionado.prazo,
            preco: state.freteSelecionado.preco
          } : null
        };
        
        const docRef = await db.collection('pedidos').add(pedidoData);
        
        // Limpar carrinho ap√≥s sucesso
        state.carrinho = []; 
        saveCart(); 
        renderCheckoutResumo(); 
        updateCartCount();
        
        // Redirecionar para Minha Conta para ver o pedido
        toast(`Pedido #${docRef.id.slice(-6)} finalizado com sucesso!`);
        setTimeout(() => {
          navigate('#minha-conta');
        }, 1500);
        
      } catch (error) {
        console.error('Erro ao finalizar pedido:', error);
        toast('Erro ao finalizar pedido. Tente novamente.');
      }
    });

    // Processar pagamento
    async function processPayment() {
      if (!state.carrinho.length) {
        toast('Adicione produtos antes de finalizar.');
        return;
      }
      
      if (!state.user) {
        toast('Fa√ßa login para finalizar o pedido.');
        openLoginModal();
        return;
      }
      
      if (!state.freteSelecionado) {
        toast('Selecione uma op√ß√£o de frete.');
        return;
      }
      
      try {
        console.log('üîç Iniciando processamento de pagamento...');
        
        // Validar configura√ß√£o das APIs
        const configValidation = validateConfig();
        console.log('üîç Resultado da valida√ß√£o:', configValidation);
        
        if (!configValidation.isValid) {
          console.error('‚ùå Configura√ß√£o inv√°lida:', configValidation.errors);
          toast('Sistema de pagamento em configura√ß√£o. Verifique as credenciais.');
          return;
        }
        
        console.log('‚úÖ Configura√ß√£o v√°lida, continuando...');
        
        // Preparar dados do pedido
        const orderData = {
          user_id: state.user.uid,
          user_email: state.user.email,
          user_name: state.user.displayName || 'Usu√°rio',
          items: state.carrinho.map(item => ({
            id: item.id,
            nome: item.nome,
            preco: item.preco,
            quantidade: item.qtd,
            cor: item.cor,
            tamanho: item.tam
          })),
          subtotal: state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0),
          shipping: {
            service_id: state.freteSelecionado.id,
            company_id: state.freteSelecionado.company_id,
            price: state.freteSelecionado.preco,
            name: state.freteSelecionado.nome,
            delivery_time: state.freteSelecionado.prazo
          },
          total: state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0) + state.freteSelecionado.preco,
          shipping_address: state.enderecoCompleto || {
            cep: qs('#cep').value.replace(/\D/g, ''),
            logradouro: qs('#logradouro').value,
            bairro: qs('#bairro').value,
            cidade: qs('#cidade').value,
            uf: qs('#uf').value,
            numero: qs('#numero').value,
            complemento: qs('#complemento').value
          },
          payment_method: 'mercado_pago',
          payment_data: {}
        };
        
        console.log('üì¶ Dados do pedido preparados:', orderData);
        
        // Criar prefer√™ncia no Mercado Pago
        const paymentData = {
          items: orderData.items.map(item => ({
            id: item.id,
            nome: item.nome,
            descricao: `${item.cor} - ${item.tamanho}`,
            quantidade: item.quantidade,
            preco: item.preco
          })),
          payer: {
            nome: orderData.user_name,
            email: orderData.user_email,
            telefone: null
          },
          external_reference: `TFI-${Date.now()}`,
          user_id: orderData.user_id
        };
        
        console.log('üõí Dados para pagamento:', paymentData);
        console.log('üõí Criando pagamento Asaas...');
        
        // Verificar se o servi√ßo est√° dispon√≠vel
        if (typeof asaasService === 'undefined') {
          console.error('‚ùå AsaasService n√£o est√° dispon√≠vel');
          toast('Erro: Servi√ßo de pagamento n√£o dispon√≠vel');
          return;
        }
        
        console.log('‚úÖ AsaasService dispon√≠vel, criando pagamento...');
        const paymentResult = await asaasService.createPixPayment(paymentData);
        
        console.log('üîÑ Resultado da cria√ß√£o do pagamento:', paymentResult);
        
        if (paymentResult.success) {
          console.log('‚úÖ Pagamento criado com sucesso, salvando pedido...');
          
          // Salvar pedido no Firebase com status pendente
          const orderRef = await db.collection('pedidos').add({
            ...orderData,
            status: 'pending_payment',
            payment_id: paymentResult.paymentId,
            external_reference: paymentData.external_reference,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          console.log('‚úÖ Pedido salvo no Firebase:', orderRef.id);
          
          // Mostrar QR Code PIX ou redirecionar
          if (paymentResult.qrCode) {
            console.log('üì± QR Code PIX gerado:', paymentResult.qrCode);
            
            // Mostrar modal com QR Code PIX
            showPixModal(paymentResult);
          } else if (paymentResult.paymentUrl) {
            console.log('üöÄ URL de pagamento:', paymentResult.paymentUrl);
            
            // Confirmar redirecionamento
            if (confirm('Redirecionar para o Asaas para finalizar o pagamento?')) {
              window.location.href = paymentResult.paymentUrl;
            }
          }
          
        } else {
          console.error('‚ùå Erro ao criar pagamento:', paymentResult.error);
          toast(`Erro ao criar pagamento: ${paymentResult.error}`);
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao processar pagamento:', error);
        console.error('‚ùå Stack trace:', error.stack);
        toast('Erro ao processar pagamento. Tente novamente.');
      }
    }
    


    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 glass rounded-xl px-4 py-3';
      t.textContent = msg; document.body.appendChild(t);
      setTimeout(()=>t.remove(),1600);
    }

    // Renderizar √°rea "Minha Conta"
    async function renderMinhaConta() {
      if (!state.user) return;
      
      // Atualizar informa√ß√µes do usu√°rio
      qs('#userName').textContent = state.user.displayName || 'Usu√°rio';
      qs('#userEmail').textContent = state.user.email;
      qs('#userSince').textContent = state.user.metadata?.creationTime ? 
        new Date(state.user.metadata.creationTime).toLocaleDateString('pt-BR') : 'Data n√£o dispon√≠vel';
      qs('#userWelcome').textContent = `Ol√°, ${state.user.displayName || 'Usu√°rio'}!`;
      
      // Carregar pedidos do usu√°rio e estat√≠sticas
      await loadUserOrders();
      await loadUserStats();
      
      // Carregar favoritos (implementar depois se necess√°rio)
      renderUserFavorites();
    }
    
    // Carregar estat√≠sticas do usu√°rio
    async function loadUserStats() {
      try {
        if (!db || !state.user) return;
        
        const snapshot = await db.collection('pedidos')
          .where('userId', '==', state.user.uid)
          .get();
        
        const orders = [];
        snapshot.forEach(doc => {
          orders.push(doc.data());
        });
        
        // Calcular estat√≠sticas
        const totalOrders = orders.length;
        const totalSpent = orders.reduce((sum, order) => sum + (order.total || 0), 0);
        const lastOrder = orders.length > 0 ? 
          orders.sort((a, b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0))[0] : null;
        
        // Atualizar interface
        qs('#totalOrders').textContent = totalOrders;
        qs('#totalSpent').textContent = fmt(totalSpent);
        qs('#lastOrder').textContent = lastOrder ? 
          new Date(lastOrder.criadoEm.seconds * 1000).toLocaleDateString('pt-BR') : 
          'Nenhum pedido';
        
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
        qs('#totalOrders').textContent = '0';
        qs('#totalSpent').textContent = 'R$ 0,00';
        qs('#lastOrder').textContent = '-';
      }
    }
    
    // Carregar pedidos do usu√°rio
    async function loadUserOrders() {
      try {
        if (!db || !state.user) return;
        
        const snapshot = await db.collection('pedidos')
          .where('userId', '==', state.user.uid)
          .orderBy('criadoEm', 'desc')
          .limit(10)
          .get();
        
        const ordersContainer = qs('#userOrders');
        ordersContainer.innerHTML = '';
        
        if (snapshot.empty) {
          ordersContainer.innerHTML = '<div class="text-slate-300 text-center py-4">Nenhum pedido encontrado</div>';
          return;
        }
        
        snapshot.forEach(doc => {
          const order = doc.data();
          const orderDate = order.criadoEm ? 
            new Date(order.criadoEm.seconds * 1000).toLocaleDateString('pt-BR') : 
            'Data n√£o dispon√≠vel';
          
          const orderEl = document.createElement('div');
          orderEl.className = 'glass rounded-xl p-4 mb-3';
          orderEl.innerHTML = `
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="font-bold text-lg">Pedido #${doc.id.slice(-6)}</div>
                <div class="text-sm text-slate-300">${orderDate}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-lg">${fmt(order.total || 0)}</div>
                <div class="text-sm badge px-2 py-1 rounded-full mt-1">${order.status || 'Pendente'}</div>
              </div>
            </div>
            
            <div class="space-y-2">
              <div class="text-sm text-slate-300">
                <strong>Itens:</strong> ${order.itens?.length || 0} produto(s)
              </div>
              ${order.freteSelecionado ? `
                <div class="text-sm text-slate-300">
                  <strong>Frete:</strong> ${order.freteSelecionado.nome} - ${order.freteSelecionado.prazo}
                </div>
              ` : ''}
              ${order.endereco?.cidade ? `
                <div class="text-sm text-slate-300">
                  <strong>Entrega:</strong> ${order.endereco.cidade}, ${order.endereco.uf}
                </div>
              ` : ''}
            </div>
            
            <div class="mt-3 pt-3 border-t border-white/10">
              <div class="text-xs text-slate-400">
                Subtotal: ${fmt(order.subtotal || 0)} | 
                Frete: ${fmt(order.frete || 0)} | 
                Total: ${fmt(order.total || 0)}
              </div>
            </div>
          `;
          ordersContainer.appendChild(orderEl);
        });
        
      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        qs('#userOrders').innerHTML = '<div class="text-slate-300 text-center py-4">Erro ao carregar pedidos</div>';
      }
    }
    
    // Renderizar favoritos do usu√°rio
    function renderUserFavorites() {
      const favoritesContainer = qs('#userFavorites');
      
      if (!state.user) {
        favoritesContainer.innerHTML = '<div class="text-slate-300 text-center py-8">Fa√ßa login para ver seus favoritos</div>';
        return;
      }
      
      if (state.favoritos.length === 0) {
        favoritesContainer.innerHTML = `
          <div class="text-slate-300 text-center py-8">
            <div class="text-4xl mb-2">‚ù§Ô∏è</div>
            <div class="text-lg font-bold mb-1">Nenhum favorito ainda</div>
            <div class="text-sm">Adicione produtos aos favoritos para v√™-los aqui</div>
          </div>
        `;
        return;
      }
      
      // Mostrar favoritos do usu√°rio
      favoritesContainer.innerHTML = '';
      state.favoritos.slice(0, 8).forEach(id => {
        const p = state.produtos.find(x => x.id === id);
        if (!p) return;
        
        const favEl = document.createElement('div');
        favEl.className = 'glass rounded-xl p-3 hover:ring-2 hover:ring-emerald-400/40 cursor-pointer';
        favEl.onclick = () => openProduto(p.id);
        favEl.innerHTML = `
          <div class="aspect-square rounded-lg overflow-hidden mb-2">
            <img src="${p.imagens[0]}" alt="${p.nome}" class="w-full h-full object-cover">
          </div>
          <div class="text-sm font-bold truncate">${p.nome}</div>
          <div class="text-emerald-400 font-bold">${fmt(p.preco)}</div>
        `;
        favoritesContainer.appendChild(favEl);
      });
      
      if (state.favoritos.length > 8) {
        const moreEl = document.createElement('div');
        moreEl.className = 'text-center py-4';
        moreEl.innerHTML = `
          <a href="#favoritos" data-route class="btn pill px-4 py-2 text-sm">
            Ver todos os ${state.favoritos.length} favoritos
          </a>
        `;
        favoritesContainer.appendChild(moreEl);
      }
    }

    // Feedbacks
    const feedbacks = [
      { nome:'Rafael', nota:5, texto:'Qualidade absurda. Caimento perfeito.', data:'h√° 2 dias' },
      { nome:'Lucas', nota:5, texto:'Entrega r√°pida e pe√ßas com presen√ßa.', data:'h√° 1 semana' },
      { nome:'Henrique', nota:4, texto:'Camiseta premium real, recomendo.', data:'h√° 3 semanas' }
    ];
    function renderFeedbacks() {
      const list = qs('#feedbackList'); list.innerHTML='';
      feedbacks.forEach(f => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl p-4';
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-bold">${f.nome}</div>
            <div class="text-sm hint">${f.data}</div>
          </div>
          <div class="mt-1 star">${'‚òÖ'.repeat(f.nota)}<span class="text-slate-600">${'‚òÖ'.repeat(5-f.nota)}</span></div>
          <p class="mt-2 text-slate-300">${f.texto}</p>
        `;
        list.appendChild(el);
      });
    }
    // estrelas input
    let currentRating = 5;
    function initRating() {
      const box = qs('#ratingStars'); box.innerHTML='';
      for (let i=1;i<=5;i++){
        const b = document.createElement('button');
        b.className = 'text-2xl'; b.textContent = '‚òÖ';
        b.style.color = (i<=currentRating)?'#ffd166':'#334155';
        b.addEventListener('click', ()=>{
          currentRating = i;
          qsa('#ratingStars button').forEach((x,idx)=> x.style.color = (idx < i)?'#ffd166':'#334155');
        });
        box.appendChild(b);
      }
      qs('#btnEnviarFeedback').onclick = async () => {
        // Verificar rate limiting
        if (!checkRateLimit('feedback', 3, 300000)) { // 3 tentativas por 5 minutos
          toast('Muitas tentativas. Aguarde 5 minutos.');
          return;
        }
        
        const txt = qs('#feedbackText').value.trim();
        if (!txt) { toast('Escreva um coment√°rio.'); return; }
        
        // Sanitizar dados
        const sanitizedText = sanitizeText(txt);
        const sanitizedName = sanitizeText(state.user?.displayName || 'Cliente');
        
        if (sanitizedText.length < 3) {
          toast('Coment√°rio muito curto.');
          return;
        }
        
        try {
          // Salvar no Firestore
          const feedbackData = {
            nome: sanitizedName,
            nota: currentRating,
            texto: sanitizedText,
            data: new Date().toLocaleDateString('pt-BR'),
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            userId: state.user?.uid || null
          };
          
          await db.collection('feedbacks').add(feedbackData);
          
          // Adicionar ao estado local
        feedbacks.unshift({ 
          nome: sanitizedName, 
          nota: currentRating, 
          texto: sanitizedText, 
          data: 'agora' 
        });
          
        qs('#feedbackText').value='';
        renderFeedbacks();
        toast('Obrigado pelo feedback!');
          
        } catch (error) {
          console.error('Erro ao salvar feedback:', error);
          toast('Erro ao enviar feedback. Tente novamente.');
        }
      };
    }

    // Chat simples
    const chatMsgs = [];
    function renderChat() {
      const box = qs('#chatBox');
      box.innerHTML = chatMsgs.map(m => `
        <div class="flex ${m.me?'justify-end':'justify-start'}">
          <div class="max-w-[80%] ${m.me?'cta-gradient':'glass'} rounded-xl px-3 py-2 my-1">${m.txt}</div>
        </div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    }
    qs('#btnChat').addEventListener('click', async () => {
      const input = qs('#chatInput'); const txt = input.value.trim();
      if (!txt) return;
      
      try {
        // Salvar mensagem no Firestore
        const mensagemData = {
          texto: sanitizeText(txt),
          remetente: 'cliente',
          userId: state.user?.uid || null,
          email: state.user?.email || null,
          criadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('mensagens').add(mensagemData);
        
        chatMsgs.push({ me:true, txt }); 
        input.value='';
      renderChat();
        
        setTimeout(()=>{ 
          chatMsgs.push({ me:false, txt:'Recebido! Nossa equipe retornar√° em breve.' }); 
          renderChat(); 
        }, 700);
        
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        toast('Erro ao enviar mensagem. Tente novamente.');
      }
    });

    // Admin: inserir produto local
    function adminFillCategorias() {
      const sel = qs('#admCategoria'); 
      sel.innerHTML='';
      state.categorias.forEach(c=>{
        const o=document.createElement('option'); 
        o.value=c; 
        o.textContent=c; 
        sel.appendChild(o);
      });
    }
    qs('#btnSalvarProduto').addEventListener('click', async () => {
      if (!state.user) { toast('Fa√ßa login com Google para salvar produtos.'); return; }
      
      // Verificar se √© edi√ß√£o
      const editId = qs('#btnSalvarProduto').getAttribute('data-edit-id');
      const isEdit = !!editId;
      
      // Verificar rate limiting
      if (!checkRateLimit('addProduct', 5, 60000)) { // 5 produtos por minuto
        toast('Muitas tentativas. Aguarde 1 minuto.');
        return;
      }
      
      // Coletar e sanitizar dados
      const nome = sanitizeText(qs('#admNome').value.trim());
      const cat = qs('#admCategoria').value;
      const preco = parseFloat(qs('#admPreco').value.replace(',','.'))||0;
      const promo = qs('#admPromo').value ? parseFloat(qs('#admPromo').value.replace(',','.')) : null;
      const imagem = qs('#admImagem').value.trim();
      const cores = qs('#admCores').value.split(',').map(s=>sanitizeText(s.trim())).filter(Boolean);
      const tams = qs('#admTamanhos').value.split(',').map(s=>sanitizeText(s.trim())).filter(Boolean);
      const desc = sanitizeText(qs('#admDesc').value.trim());
      const composicao = sanitizeText(qs('#admComposicao').value.trim()) || 'A definir';
      const estilo = sanitizeText(qs('#admEstilo').value.trim()) || 'TFI Signature';
      const envio = sanitizeText(qs('#admEnvio').value.trim()) || 'R√°pido e rastre√°vel';
      
      // Validar dados
      const produto = { nome, categoria: cat, preco, promo, cores, tamanhos: tams, descricao: desc, composicao, estilo, envio };
      const validation = validateProduct(produto);
      
      if (!validation.isValid) {
        toast('Erro: ' + validation.errors.join(', '));
        return;
      }
      
      if (!nome || !preco || !cores.length || !tams.length) { 
        toast('Preencha os campos obrigat√≥rios.'); 
        return; 
      }
      
      try {
        if (isEdit) {
          // Verificar se o documento existe no Firestore
          const docRef = db.collection('produtos').doc(editId);
          const docSnapshot = await docRef.get();
          
          const produtoData = {
            nome,
            categoria: cat,
            preco,
            promo,
            cores,
            tamanhos: tams,
            descricao: desc || 'Sem descri√ß√£o',
            composicao,
            estilo,
            envio,
            imagem: imagem || null,
            imagens: imagem ? [imagem] : ['svg'],
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          if (docSnapshot.exists) {
            // Documento existe, atualizar
            await docRef.update(produtoData);
          } else {
            // Documento n√£o existe, criar novo
            await docRef.set({
              ...produtoData,
              criadoPor: state.user.uid,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          // Atualizar no estado local
          const idx = state.produtos.findIndex(p => p.id === editId);
          if (idx >= 0) {
            state.produtos[idx] = { ...state.produtos[idx], ...produtoData };
          }
          
          toast('Produto atualizado com sucesso!');
          
        } else {
          // Criar novo produto
          const produtoData = {
        nome, 
        categoria: cat, 
        preco, 
        promo, 
        cores, 
        tamanhos: tams, 
        novas: true, 
        destaque: false, 
        descricao: desc || 'Sem descri√ß√£o', 
        composicao: 'A definir', 
        estilo: 'TFI Signature', 
            imagem: imagem || null,
            imagens: imagem ? [imagem] : ['svg'],
            criadoPor: state.user.uid,
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          const docRef = await db.collection('produtos').add(produtoData);
          
          // Adicionar ao estado local
          const novo = { 
            id: docRef.id, 
            ...produtoData
      };
      
      state.produtos.unshift(novo);
          toast('Produto salvo com sucesso!');
        }
        
      persistLocalProducts();
      filterAndRenderCatalog(); 
      renderDestaques(); 
      renderNovidades(); 
      renderAdminList();
        
        // Limpar formul√°rio e resetar bot√£o
        ['#admNome','#admPreco','#admPromo','#admImagem','#admCores','#admTamanhos','#admDesc','#admComposicao','#admEstilo','#admEnvio'].forEach(s=>qs(s).value='');
        qs('#btnSalvarProduto').textContent = 'Salvar Produto';
        qs('#btnSalvarProduto').removeAttribute('data-edit-id');
        
      } catch (error) {
        console.error('Erro ao salvar produto:', error);
        
        // Mensagem de erro mais espec√≠fica
        if (error.code === 'permission-denied') {
          toast('Erro de permiss√£o. Verifique se voc√™ tem acesso de administrador.');
        } else if (error.code === 'not-found') {
          toast('Produto n√£o encontrado. Tente recarregar a p√°gina.');
        } else if (error.message.includes('No document to update')) {
          toast('Produto n√£o existe no servidor. Criando novo produto...');
          // Tentar criar como novo produto
          try {
            const docRef = await db.collection('produtos').add({
              nome,
              categoria: cat,
              preco,
              promo,
              cores,
              tamanhos: tams,
              descricao: desc || 'Sem descri√ß√£o',
              composicao,
              estilo,
              envio,
              imagem: imagem || null,
              imagens: imagem ? [imagem] : ['svg'],
              criadoPor: state.user.uid,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
              atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Atualizar ID no estado local
            const idx = state.produtos.findIndex(p => p.id === editId);
            if (idx >= 0) {
              state.produtos[idx].id = docRef.id;
            }
            
            toast('Produto criado com sucesso!');
          } catch (createError) {
            console.error('Erro ao criar produto:', createError);
            toast('Erro ao criar produto. Tente novamente.');
          }
        } else {
          toast('Erro ao salvar produto. Tente novamente.');
        }
      }
    });

    // Event listeners para cole√ß√£o destaque
    qs('#featuredCollectionName').addEventListener('input', (e) => {
      state.featuredCollection.name = e.target.value;
      updateFeaturedPreview();
    });

    qs('#btnSaveFeatured').addEventListener('click', () => {
      saveFeaturedCollection();
      toast('Cole√ß√£o destaque salva com sucesso!');
    });
    function renderAdminList() {
      const box = qs('#adminLista'); 
      box.innerHTML='';
      
      // Atualizar contador de produtos
      qs('#totalProducts').textContent = state.produtos.length;
      
      state.produtos.forEach(p=>{
        const row = document.createElement('div');
        row.className='glass rounded-xl p-4 flex items-center justify-between hover:ring-2 hover:ring-emerald-400/20 transition-all';
        row.innerHTML = `
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0">
              ${p.imagem ? 
                `<img src="${p.imagem}" alt="${p.nome}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="w-full h-full flex items-center justify-center text-gray-400" style="display:none;">üì¶</div>` :
                `<div class="w-full h-full flex items-center justify-center text-gray-400">üì¶</div>`
              }
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-lg truncate">${p.nome}</div>
              <div class="hint text-sm mb-1">${p.categoria}</div>
              <div class="flex items-center gap-2 text-sm">
                <span class="font-semibold text-emerald-400">${fmt(p.promo ?? p.preco)}</span>
                ${p.promo ? `<span class="line-through text-slate-500">${fmt(p.preco)}</span>` : ''}
                ${p.destaque ? '<span class="badge px-2 py-1 rounded-full text-xs">Destaque</span>' : ''}
                ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-300">Novo</span>' : ''}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn pill px-3 py-2 rounded-lg text-xs hover:bg-blue-500/20 hover:text-blue-300" data-id="${p.id}" data-act="edit">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              Editar
            </button>
            <button class="btn pill px-3 py-2 rounded-lg text-xs ${p.destaque ? 'bg-yellow-500/20 text-yellow-300 hover:bg-yellow-500/30' : 'hover:bg-yellow-500/20 hover:text-yellow-300'}" data-id="${p.id}" data-act="dest">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
              </svg>
              ${p.destaque ? 'Remover Destaque' : 'Destacar'}
            </button>
            <button class="btn pill px-3 py-2 rounded-lg text-xs hover:bg-red-500/20 hover:text-red-300" data-id="${p.id}" data-act="delete">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Excluir
            </button>
          </div>
        `;
        box.appendChild(row);
      });
      box.onclick = async (e)=>{
        const b = e.target.closest('button'); if(!b) return;
        const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
        const idx = state.produtos.findIndex(p=>p.id===id); if (idx<0) return;
        
        try {
          if (act==='edit') {
            // Preencher formul√°rio com dados do produto
            const produto = state.produtos[idx];
            qs('#admNome').value = produto.nome || '';
            qs('#admCategoria').value = produto.categoria || '';
            qs('#admPreco').value = produto.preco || '';
            qs('#admPromo').value = produto.promo || '';
            qs('#admImagem').value = produto.imagem || '';
            qs('#admCores').value = produto.cores ? produto.cores.join(', ') : '';
            qs('#admTamanhos').value = produto.tamanhos ? produto.tamanhos.join(', ') : '';
            qs('#admDesc').value = produto.descricao || '';
            qs('#admComposicao').value = produto.composicao || '';
            qs('#admEstilo').value = produto.estilo || '';
            qs('#admEnvio').value = produto.envio || '';
            
            // Alterar bot√£o para "Atualizar"
            qs('#btnSalvarProduto').textContent = 'Atualizar Produto';
            qs('#btnSalvarProduto').setAttribute('data-edit-id', id);
            
            // Scroll para o formul√°rio
            qs('#admNome').scrollIntoView({ behavior: 'smooth' });
            toast('Formul√°rio preenchido. Edite e clique em "Atualizar Produto".');
          }
          else if (act==='dest') {
            state.produtos[idx].destaque = !state.produtos[idx].destaque;
            // Atualizar no Firestore se dispon√≠vel
            if (db) {
              try {
                await db.collection('produtos').doc(id).update({
                  destaque: state.produtos[idx].destaque,
                  atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
              } catch (error) {
                console.error('Erro ao atualizar destaque no Firestore:', error);
              }
            }
            toast('Destaque atualizado!');
          }
          else if (act==='delete') {
            // Excluir produto
            if (confirm(`Tem certeza que deseja excluir o produto "${state.produtos[idx].nome}"?`)) {
              // Remover do Firestore se dispon√≠vel
              if (db) {
                try {
                  await db.collection('produtos').doc(id).delete();
                } catch (error) {
                  console.error('Erro ao excluir produto do Firestore:', error);
                }
              }
              
              // Remover do estado local
              state.produtos.splice(idx, 1);
              
              // Remover da cole√ß√£o destaque se estiver l√°
              const featuredIndex = state.featuredCollection.products.indexOf(id);
              if (featuredIndex > -1) {
                state.featuredCollection.products.splice(featuredIndex, 1);
                saveFeaturedCollection();
              }
              
              toast('Produto exclu√≠do com sucesso!');
            }
          }
          
          persistLocalProducts(); 
          renderAdminList(); 
          renderDestaques(); 
          filterAndRenderCatalog(); 
          renderNovidades();
          
        } catch (error) {
          console.error('Erro ao atualizar produto:', error);
          toast('Erro ao atualizar produto.');
        }
      }
    }
    function persistLocalProducts() {
      localStorage.setItem('tfi_products', JSON.stringify(state.produtos));
    }
    function loadLocalProducts() {
      try {
        const arr = JSON.parse(localStorage.getItem('tfi_products')||'[]');
        if (Array.isArray(arr) && arr.length) state.produtos = arr;
      } catch {}
    }

    // Admin: Gerenciar Cole√ß√£o Destaque
    function renderFeaturedProductsList() {
      const container = qs('#featuredProductsList');
      container.innerHTML = '';
      
      state.produtos.forEach(produto => {
        const isSelected = state.featuredCollection.products.includes(produto.id);
        const canSelect = !isSelected && state.featuredCollection.products.length < 3;
        
        const item = document.createElement('div');
        item.className = `flex items-center justify-between p-2 rounded-lg border ${isSelected ? 'border-emerald-400 bg-emerald-400/10' : 'border-slate-600'}`;
        item.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-slate-700 flex items-center justify-center">
              ${produto.imagem ? `<img src="${produto.imagem}" alt="${produto.nome}" class="w-6 h-6 rounded object-cover">` : 'üì¶'}
            </div>
            <div>
              <div class="text-sm font-medium">${produto.nome}</div>
              <div class="text-xs text-slate-400">${produto.categoria}</div>
            </div>
          </div>
          <button class="btn pill px-3 py-1 text-xs ${isSelected ? 'bg-emerald-500 text-black' : canSelect ? 'hover:bg-emerald-500/20' : 'opacity-50 cursor-not-allowed'}" 
                  data-id="${produto.id}" 
                  ${!canSelect && !isSelected ? 'disabled' : ''}>
            ${isSelected ? 'Remover' : 'Adicionar'}
          </button>
        `;
        
        if (canSelect || isSelected) {
          item.querySelector('button').addEventListener('click', () => {
            toggleFeaturedProduct(produto.id);
          });
        }
        
        container.appendChild(item);
      });
      
      updateFeaturedPreview();
    }

    function toggleFeaturedProduct(productId) {
      const index = state.featuredCollection.products.indexOf(productId);
      
      if (index > -1) {
        // Remover produto
        state.featuredCollection.products.splice(index, 1);
      } else if (state.featuredCollection.products.length < 3) {
        // Adicionar produto
        state.featuredCollection.products.push(productId);
      }
      
      renderFeaturedProductsList();
      saveFeaturedCollection();
    }

    function updateFeaturedPreview() {
      qs('#previewCollectionName').textContent = state.featuredCollection.name;
      qs('#previewProductCount').textContent = state.featuredCollection.products.length;
      
      // Atualizar tamb√©m o nome na home
      const homeElement = qs('#homeCollectionName');
      if (homeElement) {
        homeElement.textContent = state.featuredCollection.name;
      }
    }

    function saveFeaturedCollection() {
      // Salvar no localStorage
      localStorage.setItem('tfi_featured_collection', JSON.stringify(state.featuredCollection));
      
      // Salvar no Firestore se estiver logado e for admin
      if (state.user && db && isAdmin()) {
        db.collection('configuracoes').doc('featured_collection').set(state.featuredCollection)
          .catch(error => {
            console.error('Erro ao salvar cole√ß√£o destaque:', error);
            toast('Erro ao salvar no servidor. Dados salvos localmente.');
          });
      }
      
      // Atualizar a se√ß√£o destaque na home
      renderDestaques();
    }

    function loadFeaturedCollection() {
      // Carregar do localStorage
      const saved = localStorage.getItem('tfi_featured_collection');
      if (saved) {
        try {
          state.featuredCollection = JSON.parse(saved);
        } catch (error) {
          console.error('Erro ao carregar cole√ß√£o destaque:', error);
        }
      }
      
      // Carregar do Firestore se estiver logado e for admin
      if (state.user && db && isAdmin()) {
        db.collection('configuracoes').doc('featured_collection').get()
          .then(doc => {
            if (doc.exists) {
              state.featuredCollection = doc.data();
              renderFeaturedProductsList();
            }
          })
          .catch(error => {
            console.error('Erro ao carregar cole√ß√£o destaque do Firestore:', error);
            // Continuar com dados do localStorage se houver erro
            renderFeaturedProductsList();
          });
      } else {
        // Se n√£o for admin, usar apenas dados locais
        renderFeaturedProductsList();
      }
    }



    // Firebase Configuration
    let firebaseConfig;
    let firebaseApp, auth, db, provider;
    
    // Servi√ßos de integra√ß√£o
    let orderManager;
    
    async function loadFirebaseConfig() {
      try {
        const configModule = await import('./config.js');
        firebaseConfig = configModule.firebaseConfig;
        console.log('Configura√ß√£o Firebase carregada');
      } catch (error) {
        console.error('Erro ao carregar configura√ß√£o:', error);
        // Fallback para configura√ß√£o padr√£o
        firebaseConfig = {
          apiKey: "AIzaSyD__XrPqFeh4_K0ih4l1reNvWxjW7VItPw",
          authDomain: "tfimports-27898.firebaseapp.com",
          projectId: "tfimports-27898",
          storageBucket: "tfimports-27898.firebasestorage.app",
          messagingSenderId: "379291286011",
          appId: "1:379291286011:web:1feb4711b5235b04c4b35e",
          measurementId: "G-B742BVBRES"
        };
      }
    }
    
    async function initializeFirebase() {
      await loadFirebaseConfig();
      
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        provider = new firebase.auth.GoogleAuthProvider();
        
        // Configura√ß√µes de seguran√ßa
        provider.addScope('email');
        provider.addScope('profile');
        
        // Configurar persist√™ncia de autentica√ß√£o
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        
        // Inicializar OrderManager
        orderManager = new OrderManager(db);
        
        // Configurar listener de mudan√ßa de estado de autentica√ß√£o
        auth.onAuthStateChanged(async u => { 
          state.user = u || null; 
          updateAuthUI(); 
          console.log('Estado de autentica√ß√£o:', u ? 'Logado' : 'Deslogado');
          
          // Carregar favoritos do usu√°rio quando logar
          if (u) {
            await loadFavoritos();
            saveLocalUserData();
          } else {
            localStorage.removeItem('tfi_user');
            // Limpar favoritos quando deslogar
            state.favoritos = [];
            updateFavoritosUI();
          }
        });
        
        console.log('Firebase inicializado com sucesso');
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
      }
    }
    function updateAuthUI() {
      if (state.user) {
        const isUserAdmin = isAdmin();
        
        // Salvar dados do usu√°rio localmente como backup
        saveLocalUserData();
        
        // Atualizar estado do admin
        qs('#authState').textContent = `Ol√°, ${state.user.displayName||'admin'}`;
        qs('#btnLogout').classList.toggle('hidden', !isUserAdmin);
        qs('#btnAdminLogin').classList.toggle('hidden', isUserAdmin);
        
        // Esconder bot√£o "Entrar" quando logado
        qs('#btnLogin').classList.add('hidden');
        
        // Mostrar links corretos na navega√ß√£o
        qs('#navMinhaConta').classList.toggle('hidden', isUserAdmin);
        qs('#navAdmin').classList.toggle('hidden', !isUserAdmin);
        qs('#navMinhaContaMobile').classList.toggle('hidden', isUserAdmin);
        qs('#navAdminMobile').classList.toggle('hidden', !isUserAdmin);
        
      } else {
        // Usu√°rio n√£o logado - limpar dados locais
        localStorage.removeItem('tfi_user');
        
        // Usu√°rio n√£o logado
        qs('#authState').textContent = 'N√£o autenticado';
        qs('#btnLogout').classList.add('hidden');
        qs('#btnAdminLogin').classList.remove('hidden');
        
        // Mostrar bot√£o "Entrar" quando n√£o logado
        qs('#btnLogin').classList.remove('hidden');
        qs('#btnLogin').textContent = 'Entrar';
        qs('#btnLogin').onclick = openLoginModal;
        
        // Esconder links de navega√ß√£o
        qs('#navMinhaConta').classList.add('hidden');
        qs('#navAdmin').classList.add('hidden');
        qs('#navMinhaContaMobile').classList.add('hidden');
        qs('#navAdminMobile').classList.add('hidden');
      }
    }
    // Login com email/senha
    async function signInEmail() {
      const email = qs('#loginEmail').value.trim();
      const password = qs('#loginPassword').value;
      
      if (!email || !password) {
        toast('Preencha email e senha.');
        return;
      }
      
      if (!auth) { toast('Login indispon√≠vel neste ambiente.'); return; }
      
      try {
        const res = await auth.signInWithEmailAndPassword(email, password);
        state.user = res.user;
        updateAuthUI();
        closeLoginModal();
        toast('Login realizado com sucesso!');
        
        // Salvar dados do usu√°rio no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no login:', error);
        if (error.code === 'auth/user-not-found') {
          toast('Usu√°rio n√£o encontrado.');
        } else if (error.code === 'auth/wrong-password') {
          toast('Senha incorreta.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inv√°lido.');
        } else {
          toast('Erro no login. Tente novamente.');
        }
      }
    }
    
    // Registro com email/senha
    async function signUpEmail() {
      const name = qs('#registerName').value.trim();
      const email = qs('#registerEmail').value.trim();
      const password = qs('#registerPassword').value;
      
      if (!name || !email || !password) {
        toast('Preencha todos os campos.');
        return;
      }
      
      if (password.length < 6) {
        toast('Senha deve ter pelo menos 6 caracteres.');
        return;
      }
      
      if (!auth) { toast('Registro indispon√≠vel neste ambiente.'); return; }
      
      try {
        const res = await auth.createUserWithEmailAndPassword(email, password);
        
        // Atualizar perfil do usu√°rio
        await res.user.updateProfile({
          displayName: name
        });
        
        state.user = res.user;
        updateAuthUI();
        closeLoginModal();
        toast('Conta criada com sucesso!');
        
        // Salvar dados do usu√°rio no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no registro:', error);
        if (error.code === 'auth/email-already-in-use') {
          toast('Email j√° est√° em uso.');
        } else if (error.code === 'auth/weak-password') {
          toast('Senha muito fraca.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inv√°lido.');
        } else {
          toast('Erro ao criar conta. Tente novamente.');
        }
      }
    }
    
    // Login com Google
    function signInGoogle() {
      if (!auth) { toast('Login indispon√≠vel neste ambiente.'); return; }
      auth.signInWithPopup(provider).then(async res => {
        state.user = res.user; 
        updateAuthUI(); 
        closeLoginModal();
        toast('Login realizado com sucesso!');
        
        // Salvar dados do usu√°rio no Firestore
        await saveUserData();
        
      }).catch((error)=> {
        console.error('Erro no login:', error);
        toast('Erro no login. Tente novamente.');
      });
    }
    
    // Salvar dados do usu√°rio no Firestore
    async function saveUserData() {
      try {
        await db.collection('usuarios').doc(state.user.uid).set({
          nome: state.user.displayName,
          email: state.user.email,
          ultimoLogin: firebase.firestore.FieldValue.serverTimestamp(),
          isAdmin: false // Por padr√£o, novos usu√°rios n√£o s√£o admin
        }, { merge: true });
      } catch (error) {
        console.error('Erro ao salvar dados do usu√°rio:', error);
      }
    }
    function signOut() {
      if (!auth) { state.user=null; updateAuthUI(); return; }
      auth.signOut().then(()=> { state.user=null; updateAuthUI(); toast('Voc√™ saiu.'); });
    }
    
    // Controle do modal de tipo de pe√ßa
    let currentProdutoIdForModal = null;
    function openTipoPecaModal(id) {
      currentProdutoIdForModal = id;
      qs('#tipoPecaModal').classList.remove('hidden');
    }
    function closeTipoPecaModal() {
      qs('#tipoPecaModal').classList.add('hidden');
      currentProdutoIdForModal = null;
    }

    // Controle do modal de login
    function openLoginModal() {
      qs('#loginModal').classList.remove('hidden');
    }
    
    function closeLoginModal() {
      qs('#loginModal').classList.add('hidden');
      // Limpar formul√°rios
      qs('#loginEmail').value = '';
      qs('#loginPassword').value = '';
      qs('#registerName').value = '';
      qs('#registerEmail').value = '';
      qs('#registerPassword').value = '';
      // Mostrar formul√°rio de login por padr√£o
      qs('#emailLoginForm').classList.remove('hidden');
      qs('#registerForm').classList.add('hidden');
    }
    
    function showRegisterForm() {
      qs('#emailLoginForm').classList.add('hidden');
      qs('#registerForm').classList.remove('hidden');
    }
    
    function showLoginForm() {
      qs('#emailLoginForm').classList.remove('hidden');
      qs('#registerForm').classList.add('hidden');
    }
    
    // Event listeners
    qs('#btnLogin').addEventListener('click', openLoginModal);
    qs('#btnAdminLogin').addEventListener('click', openLoginModal);
    qs('#closeLogin').addEventListener('click', closeLoginModal);
    qs('#closeTipoPecaModal').addEventListener('click', closeTipoPecaModal);
    
    // Event listeners do modal de tipo de pe√ßa
    qs('#tipoPecaModal').addEventListener('click', (e) => {
      if (e.target === qs('#tipoPecaModal')) {
        closeTipoPecaModal();
      }
    });
    
    // Event listeners dos bot√µes do modal de tipo de pe√ßa
    qs('#tipoPecaModal').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-tipo]');
      if (!btn || !currentProdutoIdForModal) return;
      
      const tipo = btn.getAttribute('data-tipo');
      if (tipo === 'ver') {
        closeTipoPecaModal();
        openProduto(currentProdutoIdForModal);
      } else if (tipo === 'adicionar') {
        closeTipoPecaModal();
        addToCart(currentProdutoIdForModal);
      }
    });
    qs('#btnEmailLogin').addEventListener('click', signInEmail);
    qs('#btnEmailRegister').addEventListener('click', signUpEmail);
    qs('#btnGoogleLogin').addEventListener('click', signInGoogle);
    qs('#btnShowRegister').addEventListener('click', showRegisterForm);
    qs('#btnShowLogin').addEventListener('click', showLoginForm);
    qs('#btnLogout').addEventListener('click', signOut);
    qs('#btnLogoutUser').addEventListener('click', signOut);
    
    // Fechar modal ao clicar fora
    qs('#loginModal').addEventListener('click', (e) => {
      if (e.target === qs('#loginModal')) {
        closeLoginModal();
      }
    });
    
    // Enter para login
    qs('#loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        signInEmail();
      }
    });
    
    qs('#registerPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        signUpEmail();
      }
    });
    
    // onAuthStateChanged agora est√° dentro de initializeFirebase()

    // Mini util: year
    qs('#year').textContent = new Date().getFullYear();

    // Inicializa√ß√£o
    async function init() {
      // Verificar dados locais do usu√°rio primeiro (fallback)
      checkLocalUserData();
      
      // Carregar configura√ß√£o do Firebase primeiro
      await initializeFirebase();
      
      // Carregar dados do Firestore
      await loadProductsFromFirestore();
      await loadFeedbacksFromFirestore();
      
      loadLocalProducts();
      loadCart();
      loadFavoritos();
      renderChips();
      renderDestaques();
      initFilters();
      filterAndRenderCatalog();
      renderNovidades();
      renderFeedbacks();
      initRating();
      renderChat();
      adminFillCategorias();
      renderAdminList();
      loadFeaturedCollection();
      renderFeaturedProductsList();
      applyRoute();
    }
    
    // Carregar produtos do Firestore
    async function loadProductsFromFirestore() {
      try {
        if (!db) return;
        
        const snapshot = await db.collection('produtos').orderBy('criadoEm', 'desc').get();
        const firestoreProducts = [];
        
        snapshot.forEach(doc => {
          firestoreProducts.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Adicionar produtos do Firestore ao estado
        state.produtos = [...firestoreProducts, ...state.produtos];
        
        console.log(`${firestoreProducts.length} produtos carregados do Firestore`);
        
      } catch (error) {
        console.error('Erro ao carregar produtos do Firestore:', error);
      }
    }
    
    // Carregar feedbacks do Firestore
    async function loadFeedbacksFromFirestore() {
      try {
        if (!db) return;
        
        const snapshot = await db.collection('feedbacks').orderBy('criadoEm', 'desc').limit(10).get();
        const firestoreFeedbacks = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          firestoreFeedbacks.push({
            nome: data.nome,
            nota: data.nota,
            texto: data.texto,
            data: data.data
          });
        });
        
        // Adicionar feedbacks do Firestore ao estado
        feedbacks.unshift(...firestoreFeedbacks);
        
        console.log(`${firestoreFeedbacks.length} feedbacks carregados do Firestore`);
        
      } catch (error) {
        console.error('Erro ao carregar feedbacks do Firestore:', error);
      }
    }
    init();

    // Fun√ß√£o para mostrar modal do PIX
    function showPixModal(paymentResult) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold mb-4 text-center">Pagamento PIX</h3>
          
          ${paymentResult.qrCode ? `
            <div class="text-center mb-4">
              <img src="${paymentResult.qrCode}" alt="QR Code PIX" class="mx-auto mb-4" style="max-width: 200px;">
              <p class="text-sm text-gray-600">Escaneie o QR Code com seu app de pagamento</p>
            </div>
          ` : ''}
          
          ${paymentResult.pixCopyPaste ? `
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">C√≥digo PIX (Copiar e Colar):</label>
              <textarea readonly class="w-full p-2 border rounded text-xs" rows="4">${paymentResult.pixCopyPaste}</textarea>
              <button onclick="navigator.clipboard.writeText('${paymentResult.pixCopyPaste}')" 
                      class="mt-2 bg-blue-500 text-white px-4 py-2 rounded text-sm">
                Copiar C√≥digo
              </button>
            </div>
          ` : ''}
          
          <div class="text-center">
            <p class="text-sm text-gray-600 mb-4">
              Ap√≥s o pagamento, envie o comprovante para:<br>
              <strong>WhatsApp: (84) 99999-9999</strong>
            </p>
            
            <div class="flex gap-2">
              <button onclick="this.closest('.fixed').remove()" 
                      class="flex-1 bg-gray-500 text-white px-4 py-2 rounded">
                Fechar
              </button>
              <button onclick="window.open('https://wa.me/5584999999999?text=Comprovante%20de%20pagamento%20PIX', '_blank')" 
                      class="flex-1 bg-green-500 text-white px-4 py-2 rounded">
                WhatsApp
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Fun√ß√£o de teste para verificar API do Asaas
    window.testAsaas = async function() {
      try {
        console.log('üß™ Testando API do Asaas...');
        
        // Verificar se o servi√ßo est√° dispon√≠vel
        if (typeof asaasService === 'undefined') {
          console.error('‚ùå AsaasService n√£o est√° dispon√≠vel');
          return false;
        }
        
        console.log('‚úÖ AsaasService dispon√≠vel');
        
        // Verificar configura√ß√£o
        const configValidation = validateConfig();
        console.log('üîç Configura√ß√£o:', configValidation);
        
        if (!configValidation.isValid) {
          console.error('‚ùå Configura√ß√£o inv√°lida:', configValidation.errors);
          return false;
        }
        
        console.log('‚úÖ Configura√ß√£o v√°lida');
        
        // Testar conex√£o com a API
        const testUrl = 'https://api.mercadopago.com/v1/payment_methods?country_id=BR';
        console.log('üåê Testando conex√£o com:', testUrl);
        
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${apiConfig.mercadoPago.accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üì° Status da resposta:', response.status);
        console.log('üì° Headers da resposta:', Object.fromEntries(response.headers.entries()));
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ API funcionando! Dados recebidos:', data);
          return true;
        } else {
          const errorText = await response.text();
          console.error('‚ùå Erro na API:', response.status, errorText);
          return false;
        }
        
      } catch (error) {
        console.error('‚ùå Erro no teste:', error);
        console.error('‚ùå Stack trace:', error.stack);
        return false;
      }
    };

    // Fun√ß√£o para verificar CSP
    window.checkCSP = function() {
      console.log('üîí Verificando Content Security Policy...');
      
      // Verificar se h√° meta tag CSP
      const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
      if (cspMeta) {
        console.log('‚úÖ Meta tag CSP encontrada:', cspMeta.content);
      } else {
        console.log('‚ùå Meta tag CSP n√£o encontrada');
      }
      
      // Verificar se h√° headers CSP no Netlify
      console.log('üåê Para verificar headers do Netlify, use:');
      console.log('curl -I https://tfimports01.com.br');
      
      return true;
    };

    // Fun√ß√£o para verificar todas as configura√ß√µes
    window.checkAllConfigs = function() {
      console.log('üîç Verificando todas as configura√ß√µes...');
      
      // Verificar configura√ß√£o da API
      const configValidation = validateConfig();
      console.log('üìã Configura√ß√£o da API:', configValidation);
      
      // Verificar se os servi√ßos est√£o dispon√≠veis
      console.log('üí≥ AsaasService:', typeof asaasService !== 'undefined' ? '‚úÖ Dispon√≠vel' : '‚ùå N√£o dispon√≠vel');
      console.log('üöö MelhorEnvioService:', typeof melhorEnvioService !== 'undefined' ? '‚úÖ Dispon√≠vel' : '‚ùå N√£o dispon√≠vel');
      
      // Verificar configura√ß√µes espec√≠ficas
      console.log('üí≥ Asaas:', {
        apiKey: apiConfig.asaas.apiKey && apiConfig.asaas.apiKey !== 'SUA_API_KEY_AQUI' ? '‚úÖ Configurada' : '‚ùå N√£o configurada',
        environment: apiConfig.asaas.environment,
        baseUrl: apiConfig.asaas.baseUrl
      });
      
      console.log('üì¶ Melhor Envio:', {
        token: apiConfig.melhorEnvio.token ? '‚úÖ Configurado' : '‚ùå N√£o configurado',
        sandbox: apiConfig.melhorEnvio.sandbox,
        baseUrl: apiConfig.melhorEnvio.baseUrl
      });
      
      return true;
    };
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9721b30b149bf202',t:'MTc1NTY5MDkwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>